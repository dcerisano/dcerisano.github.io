function rgb_led_matrix_init(){var G=false,S=1,O=1,I=null,Z=true,v=true,aa=null,r=null,q=null,x=null,k=null,a=8,d=1,N=0,o=0,C=0,Y=0,L=0,g=0,e=0,W=null,m=null,c=null,H=[],K=8080,z=8443,f=[],b=[];function Q(){G&&console.log("WEBSOCKET: OPEN");t();this.send(json("get_webgl_req"));this.send(json("get_info_req"))}function F(ad){G&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+ad.data.toString());var ac=servers.data[selected_server].values.address==new URL(ad.origin).hostname;var ab=JSON.parse(ad.data.toString());var af=ab.method;var ae=ab.params;switch(af){case"discover_server_ack":E(ae);break;case"get_info_ack":s(ae);break;case"set_colors_ack":if(ac){aa=ae}break;case"get_data_ack":if(ac){get_data_ack(ae)}break;case"get_webgl_ack":if(ac){M(ae.vertex_shader,ae.fragment_shader)}break;default:}}function A(ab){G&&console.log("WEBSOCKET: ONCLOSE");data_close(new URL(this.url).hostname);update_server_menu()}function l(ab){G&&console.log("WEBSOCKET: ONERROR ")}function i(){try{discovering=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var ab=new RTCPeerConnection({iceServers:[]});ab.createDataChannel("");ab.createOffer(ab.setLocalDescription.bind(ab),T);ab.onicecandidate=J}catch(ac){console.log(ac.message)}}function T(){}function J(ab){if(!ab||!ab.candidate||!ab.candidate.candidate){return}var ac=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ab.candidate.candidate)[1];this.onicecandidate=T;ip=ac.split(".")[0]+"."+ac.split(".")[1]+"."+ac.split(".")[2];scan_counter=0;setTimeout(X,20)}function X(){scan_counter++;if(scan_counter<255){var ab=ip+"."+scan_counter;p(ab);setTimeout(X,20)}}function y(){for(var ab=0;ab<H.length;++ab){H.shift().abort()}}function p(ab){R(ab).then(function(ac){n(ac);y()},function(ac){})}function R(ab){return new Promise(function(ad,ac){try{var af=new XMLHttpRequest();H.push(af);af.ip=ab;af.timeout=1000;af.open("GET","http://"+ab+":"+K,true);af.ontimeout=function(ag){ac(Error("NA"))};af.onerror=function(){ac(Error("NA"))};af.onload=function(ah){if(af.readyState===4){if(af.status===200){console.log("FOUND SERVER: "+this.ip);var ag={};ag.ws="ws://"+this.ip+":"+K;ag.ip=this.ip;ad(ag)}}};af.send()}catch(ae){"XHR:"+console.log(ae.message)}})}function n(ad){try{var ab=new WebSocket(ad.ws);ab.onopen=Q;ab.onclose=A;ab.onerror=l;ab.onmessage=F;var ae=false;if(num_servers>0){for(var ac=0;ac<num_servers;ac++){if(ad.ip===servers.data[ac].values.address){console.log("FOUND "+ad.ip);servers.data[ac].socket=ab;if(selected_server==-1){selected_server=ac}ae=true}}}if(selected_server==-1){selected_server=0}if(!ae){servers.data[num_servers]={};servers.data[num_servers].socket=ab;servers.data[num_servers].id=num_servers+1;servers.data[num_servers].values={};servers.data[num_servers].values.address=ad.ip;if(num_servers==0){servers.data[num_servers].values.selected=true}num_servers++}else{servers.data[selected_server].values.selected=true;update_server_menu();serverGrid.processJSON(servers);serverGrid.tableLoaded()}}catch(af){console.log("DISCOVERY ERROR");console.log(af.message)}}function s(ac){for(var ab=0;ab<num_servers;ab++){if(ac.ip===servers.data[ab].values.address){servers.data[ab].values.hostname=ac.hostname;servers.data[ab].values.platform=ac.platform;servers.data[ab].values.status=ac.status}}update_server_menu();serverGrid.processJSON(servers);serverGrid.tableLoaded()}function E(ac){var ab={};ab.ws="ws://"+ac.ip+":"+K;ab.ip=ac.ip;n(ab)}function t(){socket_send(selected_server,"get_data_req",null);connected=true}function w(){if(!connected){i()}console.log(connected)}setInterval(w,5000);function u(){if(aa&&aa.width&&aa.height&&aa.colors&&aa.colors.data){I=aa.colors.data;const ac=twgl.createTexture(r,{width:aa.width,height:aa.height,internalFormat:r.RGB,min:r.NEAREST,mag:r.NEAREST,src:I});twgl.resizeCanvasToDisplaySize(r.canvas,window.devicePixelRatio);r.viewport(0,0,r.canvas.width,r.canvas.height);const ab={time:Math.random()/5,canvas_resolution:[r.canvas.width,r.canvas.height],texture_resolution:[aa.width,aa.height],tex:ac};twgl.setUniforms(q,ab);twgl.drawBufferInfo(r,k);r.deleteTexture(ac)}requestAnimationFrame(u)}function D(){G&&console.log("UI INIT");w()}function w(){show_button.style.color="red";if(!connected){i()}}function t(){G&&console.log("UI CONNECTED");connected=true;show_button.style.color="green";socket_send(selected_server,"get_data_req",null)}function M(ac,ab){vs.text=ac;fs.text=ab;x={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};r=document.querySelector("#canvas").getContext("webgl");q=twgl.createProgramInfo(r,["vs","fs"]);k=twgl.createBufferInfoFromArrays(r,x);r.useProgram(q.program);twgl.setBuffersAndAttributes(r,q,k);requestAnimationFrame(u)}function V(){v=!v;if(v){ui.style.display="none";canvas.style.opacity=1;show_button.innerHTML="<B>Show</B>";server_button.style.display="none";layer_button.style.display="none";shader_button.style.display="none";device_button.style.display="none";server_config.style.display="none"}else{ui.style.display="inline-block";canvas.style.opacity=0.5;show_button.innerHTML="<B>Hide</B>";server_button.style.display="block";layer_button.style.display="block";shader_button.style.display="block";device_button.style.display="block";server_config.style.display="flex"}}function P(){var ab=document.createElement("option");ab.text="None";server_menu.add(ab);init_grids();show_button.style.display="block";show_button.onclick=V;server_button.onclick=h;layer_button.onclick=B;shader_button.onclick=U;device_button.onclick=j;server_menu.onchange=server_menu_onchange;v=true;V();h()}function h(){server_button.style.color="white";server_grid.style.display="block";layer_button.style.color="gray";layer_grid.style.display="none";shader_button.style.color="gray";shader_grid.style.display="none";device_button.style.color="gray";device_grid.style.display="none"}function B(){server_button.style.color="gray";server_grid.style.display="none";layer_button.style.color="white";layer_grid.style.display="block";shader_button.style.color="gray";shader_grid.style.display="none";device_button.style.color="gray";device_grid.style.display="none"}function U(){server_button.style.color="gray";server_grid.style.display="none";shader_button.style.color="white";shader_grid.style.display="block";layer_button.style.color="gray";layer_grid.style.display="none";device_button.style.color="gray";device_grid.style.display="none"}function j(){server_button.style.color="gray";server_grid.style.display="none";layer_button.style.color="gray";layer_grid.style.display="none";shader_button.style.color="gray";shader_grid.style.display="none";device_button.style.color="white";device_grid.style.display="block"}P();D()};