function rgb_led_matrix_init(){var M=false,w=null,L=null,h=null,ap={},o={},I="localhost:8080",ab=null,ad=1,s=false,C=false,Y=1,S=null,an=true,m=document.getElementById("canvas"),P=document.getElementById("ui"),ah=document.getElementById("menu"),v=true,F=null,D=null,am=m.getContext("2d"),a=8,d=1,X=0,q=0,B=0,ak=0,W=0,g=0,e=0,ag=null,n=null,c=null,z=false,ao=false,N=[],U=8080,ab=null;function Q(aq,at,ar){M&&console.log("WEBSOCKET: CONNECT");if(ao&&ab!=null){M&&console.log("WEBSOCKET: ATTEMPTING TO REUSE");p(ab)}else{k()}}function aa(){M&&console.log("WEBSOCKET: OPEN");socket=this;t()}function K(ar){M&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+ar.data.toString());var aq=JSON.parse(ar.data.toString());var au=aq.method;var at=aq.params;switch(au){case"set_colors_ack":u(at);aj(at);break;case"get_shaders_ack":w=at;break;case"get_devices_ack":L=at;break;case"get_images_ack":h=at;break;default:}}function A(aq){M&&console.log("WEBSOCKET: ONCLOSE");O()}function l(aq){M&&console.log("WEBSOCKET: ONERROR")}function H(ar,aq){M&&console.log("WEBSOCKET: SENT MESSAGE TO SERVER: "+V(ar,aq));if(socket.readyState===socket.OPEN){socket.send(V(ar,aq))}}function V(at,ar){var aq={method:at,params:ar};return JSON.stringify(aq)}function k(){try{z=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var aq=new RTCPeerConnection({iceServers:[]});aq.createDataChannel("");aq.createOffer(aq.setLocalDescription.bind(aq),ae);aq.onicecandidate=T}catch(ar){console.log(ar.message)}}function T(aq){if(!aq||!aq.candidate||!aq.candidate.candidate){return}var ar=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(aq.candidate.candidate)[1];this.onicecandidate=ae;ip=ar.split(".")[0]+"."+ar.split(".")[1]+"."+ar.split(".")[2];setTimeout(R,5000);scan_counter=0;setTimeout(ai,20)}function ai(){scan_counter++;if(scan_counter<255){var aq=ip+"."+scan_counter;r(aq);setTimeout(ai,20)}}function ae(){}function R(){M&&console.log("DISCOVER TIMEOUT");z=false;if(!ao){}}function y(){for(var aq=0;aq<N.length;++aq){N.shift().abort()}}function r(aq){ac(aq).then(function(ar){p(ar);y()},function(ar){})}function ac(aq){return new Promise(function(at,ar){try{var av=new XMLHttpRequest();N.push(av);av.ip=aq;av.timeout=1000;av.open("GET","http://"+aq+":"+U,true);av.ontimeout=function(aw){ar(Error("NA"))};av.onerror=function(){ar(Error("NA"))};av.onload=function(aw){if(av.readyState===4){if(av.status===200){console.log("FOUND SERVER: "+this.ip);ao=true;ab="ws://"+this.ip+":"+U;at(ab)}}};av.send()}catch(au){console.log(au.message)}})}function p(aq){try{socket=new WebSocket(aq);socket.onopen=aa;socket.onclose=A;socket.onerror=l;socket.onmessage=function(at){K(at)}}catch(ar){SIGNAL_DEBUG&&console.log("DISCOVERY ERROR");SIGNAL_DEBUG&&console.log(ar.message)}}function aj(aq){}G();function G(){M&&console.log("UI INIT");x()}function x(){if(!C){Q("ws://"+I,t,O)}}function t(){M&&console.log("UI CONNECTED");C=true}function O(){M&&console.log("UI DISCONNECTED");C=false;u(null);x()}function J(au){var aq=this.getRowValues(au);aq.name=aq.name;var at=0;for(var ar=0;ar<this.getRowCount();ar++){at=Math.max(at,parseInt(this.getRowId(ar))+1)}this.insertAfter(au,at,aq)}function af(){if(window.location.hostname==="standard3d.com"){return}v=!v;if(v){P.style.display="none";m.style.opacity=1;ah.innerHTML="<b>SHOW</b>";ah.style.color="gray"}else{P.style.display="inline-block";m.style.opacity=0.5;ah.innerHTML="<b>HIDE&nbsp;&nbsp;&nbsp;&nbsp;SAVE&nbsp;&nbsp;&nbsp;&nbsp;LOAD&nbsp;&nbsp;&nbsp;&nbsp;UNDO</b>";ah.style.color="white"}}function Z(){document.getElementsByTagName("BODY")[0].onresize=u;F=new EditableGrid("Layers");F.tableLoaded=function(){F.duplicate=J;this.setCellRenderer("action",new CellRenderer({render:function(aq,ar){var at=F.getRowId(aq.rowIndex);aq.innerHTML='<a onclick="if (layerGrid.data.length>1) layerGrid.remove('+aq.rowIndex+'); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aq.innerHTML+='&nbsp;<a onclick="layerGrid.duplicate('+aq.rowIndex+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>'}}));this.renderGrid("layers","grid")};F.loadJSON("data/layers.json");D=new EditableGrid("Properties");D.tableLoaded=function(){D.duplicate=J;this.setCellRenderer("action",new CellRenderer({render:function(aq,ar){var at=D.getRowId(aq.rowIndex);aq.innerHTML='<a onclick="if (propertyGrid.data.length>1) propertyGrid.remove('+aq.rowIndex+'); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aq.innerHTML+='&nbsp;<a onclick="propertyGrid.duplicate('+aq.rowIndex+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>'}}));this.renderGrid("properties","grid")};D.loadJSON("data/properties.json");ah.onclick=af}Z();function u(ar){if(ar&&ar.shader_params&&ar.shader_params.width&&ar.shader_params.height&&ar.colors&&ar.colors.data){a=ar.shader_params.width;d=ar.shader_params.height;if(ar.colors){S=ar.colors.data}}else{a=8;d=1;S=new Uint8Array(24).fill(0)}b(ar);M&&console.log("drawMatrix");if(d*a*3!=S.length){return}for(i=0;i<a;i++){for(j=0;j<d;j++){var aq=B*(i+1),at=ak*(j+1);if(an){f(aq,at,al(W,i,j),E(i,j))}else{f(aq,at,W,E(i,j))}}}}function b(){M&&console.log("resizeMatrix");X=window.innerWidth;q=window.innerHeight;g=0;e=0;m.width=X;m.height=q;m.style.width=X;m.style.height=q;B=X/(a+1);ak=q/(d+1);if(B>ak){B=ak}else{ak=B}e=(q-ak*(d+1))/2;g=(X-B*(a+1))/2;W=B*0.4}function E(ar,av){var au=S[(av*a+ar)*3+0],at=S[(av*a+ar)*3+1],aq=S[(av*a+ar)*3+2];if(typeof au!=="undefined"&&at!=="undefined"&&aq!=="undefined"){return"rgba("+au+","+at+","+aq+", 1.0)"}else{return null}}function al(ar,at,aw){var av=S[(aw*a+at)*3+0]/255,au=S[(aw*a+at)*3+1]/255,aq=S[(aw*a+at)*3+2]/255;return ar*Math.max(0.25,av*0.2125+au*0.7154+aq*0.0721)}function f(ar,au,aq,at){if(at){am.beginPath();am.arc(ar+g,au+e,aq,0,2*Math.PI,false);am.fillStyle=at;am.fill();am.lineWidth=1;am.strokeStyle="#101010";am.stroke()}}};