function rgb_led_matrix_init(){var ah=false,S="localhost:8080",Z=null,n=1,L=false,ai=false,V=1,ag=null,b=true,aA=document.getElementById("canvas"),G=document.getElementById("ui"),m=document.getElementById("menu"),aC=document.getElementById("show_button"),ae=document.getElementById("layer_button"),o=document.getElementById("shader_button"),p=document.getElementById("device_button"),c=document.getElementById("connect_button"),K=document.getElementById("layer_grid"),aq=document.getElementById("shader_grid"),ar=document.getElementById("device_grid"),ao=document.getElementById("fs"),s=document.getElementById("vs"),aw=true,q=null,ay=null,T=null,aa=null,e=null,J=null,Y=null,am=8,l=1,E=0,F=0,h=0,t=0,u=0,X=0,M=0,i=null,az=null,al=null,aB=false,x=false,y=[],B=8080,r=8443,Z=null,an=null;function j(aD){ah&&console.log("WEBSOCKET: CONNECT");if(x&&Z!=null){ah&&console.log("WEBSOCKET: ATTEMPTING TO REUSE");R(Z)}else{A()}}function v(){ah&&console.log("WEBSOCKET: OPEN");socket=this;w()}function f(aE){ah&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+aE.data.toString());var aD=JSON.parse(aE.data.toString());var aG=aD.method;var aF=aD.params;switch(aG){case"set_colors_ack":an=aF;break;case"get_data_ack":C(aF);break;case"get_webgl_ack":g(aF.vertex_shader,aF.fragment_shader);break;default:}}function H(aD){ah&&console.log("WEBSOCKET: ONCLOSE");ad()}function ac(aD){ah&&console.log("WEBSOCKET: ONERROR")}function a(aE,aD){ah&&console.log("WEBSOCKET: SENT MESSAGE TO SERVER: "+N(aE,aD));if(socket.readyState===socket.OPEN){socket.send(N(aE,aD))}}function N(aF,aE){var aD={method:aF,params:aE};console.log(JSON.stringify(aD));return JSON.stringify(aD)}function A(){try{aB=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var aD=new RTCPeerConnection({iceServers:[]});aD.createDataChannel("");aD.createOffer(aD.setLocalDescription.bind(aD),ak);aD.onicecandidate=ap}catch(aE){console.log(aE.message)}}function ap(aD){if(!aD||!aD.candidate||!aD.candidate.candidate){return}var aE=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(aD.candidate.candidate)[1];this.onicecandidate=ak;ip=aE.split(".")[0]+"."+aE.split(".")[1]+"."+aE.split(".")[2];setTimeout(P,5000);scan_counter=0;setTimeout(O,20)}function O(){scan_counter++;if(scan_counter<255){var aD=ip+"."+scan_counter;au(aD);setTimeout(O,20)}}function ak(){}function P(){ah&&console.log("DISCOVER TIMEOUT");aB=false;if(!x){}}function W(){for(var aD=0;aD<y.length;++aD){y.shift().abort()}}function au(aD){aj(aD).then(function(aE){R(aE);W()},function(aE){})}function aj(aD){return new Promise(function(aF,aE){try{var aH=new XMLHttpRequest();y.push(aH);aH.ip=aD;aH.timeout=1000;aH.open("GET","http://"+aD+":"+B,true);aH.ontimeout=function(aI){aE(Error("NA"))};aH.onerror=function(){aE(Error("NA"))};aH.onload=function(aI){if(aH.readyState===4){if(aH.status===200){console.log("FOUND SERVER: "+this.ip);x=true;Z="ws://"+this.ip+":"+B;aF(Z)}}};aH.send()}catch(aG){console.log(aG.message)}})}function R(aD){try{socket=new WebSocket(aD);socket.onopen=v;socket.onclose=H;socket.onerror=ac;socket.onmessage=function(aF){f(aF)}}catch(aE){SIGNAL_DEBUG&&console.log("DISCOVERY ERROR");SIGNAL_DEBUG&&console.log(aE.message)}}function at(){if(an&&an.shader_params&&an.shader_params.width&&an.shader_params.height&&an.colors&&an.colors.data){am=an.shader_params.width;l=an.shader_params.height;if(an.colors){ag=an.colors.data}}else{am=8;l=8;ag=new Uint8Array(am*l*3).fill(32)}const aE=twgl.createTexture(aa,{width:am,height:l,internalFormat:aa.RGB,min:aa.NEAREST,mag:aa.NEAREST,src:ag});twgl.resizeCanvasToDisplaySize(aa.canvas,window.devicePixelRatio);aa.viewport(0,0,aa.canvas.width,aa.canvas.height);const aD={time:Math.random()/5,canvas_resolution:[aa.canvas.width,aa.canvas.height],texture_resolution:[am,l],tex:aE};if(l*am*3!=ag.length){return}twgl.setUniforms(e,aD);twgl.drawBufferInfo(aa,Y);aa.deleteTexture(aE);requestAnimationFrame(at)}function ax(){an=null}"use strict";function ab(aD){}k();function k(){ah&&console.log("UI INIT");av()}function av(){c.style.color="red";c.innerHTML="<b>CONNECTING</b>";if(!ai){j("ws://"+S)}}function w(){ah&&console.log("UI CONNECTED");ai=true;c.style.color="green";c.innerHTML="<b>CONNECTED</b>";a("get_data_req",null)}function ad(){ah&&console.log("UI DISCONNECTED");ai=false;ax();av()}function g(aE,aD){s.text=aE;ao.text=aD;J={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};aa=document.querySelector("#canvas").getContext("webgl");e=twgl.createProgramInfo(aa,["vs","fs"]);Y=twgl.createBufferInfoFromArrays(aa,J);aa.useProgram(e.program);twgl.setBuffersAndAttributes(aa,e,Y);requestAnimationFrame(at)}function af(aG){var aD=this.getRowValues(aG);aD.name=aD.name;var aF=0;for(var aE=0;aE<this.getRowCount();aE++){aF=Math.max(aF,parseInt(this.getRowId(aE))+1)}this.insertAfter(aG,aF,aD);z()}function I(){aw=!aw;if(aw){G.style.display="none";aA.style.opacity=1;aC.innerHTML="<B>SHOW</B>";ae.style.display="none";o.style.display="none";p.style.display="none";c.style.display="none"}else{G.style.display="inline-block";aA.style.opacity=0.5;aC.innerHTML="<B>HIDE</B>";ae.style.display="block";o.style.display="block";p.style.display="block";c.style.display="block"}}function Q(){q=new EditableGrid("Layers");q.modelChanged=z;q.tableLoaded=function(){q.duplicate=af;this.setCellRenderer("action",new CellRenderer({render:function(aD,aE){var aF=q.getRowId(aD.rowIndex);aD.innerHTML='<a onclick="if (layerGrid.data.length>1) layerGrid.remove('+aD.rowIndex+'); set_data_req(); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aD.innerHTML+='&nbsp;<a onclick="layerGrid.duplicate('+aD.rowIndex+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>'}}));this.renderGrid("layer_grid","grid")};ay=new EditableGrid("Shaders");ay.modelChanged=z;ay.tableLoaded=function(){ay.duplicate=af;this.setCellRenderer("action",new CellRenderer({render:function(aD,aE){var aF=ay.getRowId(aD.rowIndex);aD.innerHTML='<a onclick="if (shaderGrid.data.length>1) shaderGrid.remove('+aD.rowIndex+'); set_data_req(); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aD.innerHTML+='&nbsp;<a onclick="shaderGrid.duplicate('+aD.rowIndex+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>'}}));this.renderGrid("shader_grid","grid")};T=new EditableGrid("Devices");T.modelChanged=z;T.tableLoaded=function(){T.duplicate=af;this.setCellRenderer("action",new CellRenderer({render:function(aD,aE){var aF=T.getRowId(aD.rowIndex);aD.innerHTML='<a onclick="if (deviceGrid.data.length>1) deviceGrid.remove('+aD.rowIndex+'); set_data_req(); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aD.innerHTML+='&nbsp;<a onclick="deviceGrid.duplicate('+aD.rowIndex+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>'}}));this.renderGrid("device_grid","grid")};aC.style.display="block";aC.onclick=I;ae.onclick=D;o.onclick=d;p.onclick=U;D()}function C(aD){console.log("GET DATA ACK");q.processJSON(aD.layers);q.tableLoaded();ay.processJSON(aD.shaders);ay.tableLoaded();T.processJSON(aD.devices);T.tableLoaded()}function z(){an={};an.layers={};an.layers.data=[];for(var aD=0;aD<q.data.length;aD++){an.layers.data[aD]={};an.layers.data[aD].id=q.data[aD].id;an.layers.data[aD].values={};an.layers.data[aD].values.zone=q.data[aD].columns[0];an.layers.data[aD].values.device=q.data[aD].columns[1];an.layers.data[aD].values.shader=q.data[aD].columns[2]}console.log("SET DATA REQ");a("set_data_req",an)}function D(){ae.style.color="white";K.style.display="block";o.style.color="gray";aq.style.display="none";p.style.color="gray";ar.style.display="none"}function d(){ae.style.color="gray";K.style.display="none";o.style.color="white";aq.style.display="block";p.style.color="gray";ar.style.display="none"}function U(){ae.style.color="gray";K.style.display="none";o.style.color="gray";aq.style.display="none";p.style.color="white";ar.style.display="block"}};