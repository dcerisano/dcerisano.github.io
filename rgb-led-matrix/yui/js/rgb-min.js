function rgb_led_matrix_init(){var ag=false,R="localhost:8080",Y=null,m=1,K=false,ah=false,U=1,af=null,b=true,az=document.getElementById("canvas"),F=document.getElementById("ui"),l=document.getElementById("menu"),aB=document.getElementById("show_button"),ad=document.getElementById("layer_button"),n=document.getElementById("shader_button"),o=document.getElementById("device_button"),J=document.getElementById("layer_grid"),ap=document.getElementById("shader_grid"),aq=document.getElementById("device_grid"),an=document.getElementById("fs"),r=document.getElementById("vs"),av=true,p=null,ax=null,S=null,Z=null,d=null,I=null,X=null,al=8,k=1,D=0,E=0,g=0,s=0,t=0,W=0,L=0,h=null,ay=null,ak=null,aA=false,w=false,x=[],A=8080,q=8443,Y=null,am=null;function i(aC){ag&&console.log("WEBSOCKET: CONNECT");if(w&&Y!=null){ag&&console.log("WEBSOCKET: ATTEMPTING TO REUSE");Q(Y)}else{z()}}function u(){ag&&console.log("WEBSOCKET: OPEN");socket=this;v()}function e(aD){ag&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+aD.data.toString());var aC=JSON.parse(aD.data.toString());var aF=aC.method;var aE=aC.params;switch(aF){case"set_colors_ack":am=aE;break;case"get_data_ack":B(aE);break;case"get_webgl_ack":f(aE.vertex_shader,aE.fragment_shader);break;default:}}function G(aC){ag&&console.log("WEBSOCKET: ONCLOSE");ac()}function ab(aC){ag&&console.log("WEBSOCKET: ONERROR")}function a(aD,aC){ag&&console.log("WEBSOCKET: SENT MESSAGE TO SERVER: "+M(aD,aC));if(socket.readyState===socket.OPEN){socket.send(M(aD,aC))}}function M(aE,aD){var aC={method:aE,params:aD};console.log(JSON.stringify(aC));return JSON.stringify(aC)}function z(){try{aA=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var aC=new RTCPeerConnection({iceServers:[]});aC.createDataChannel("");aC.createOffer(aC.setLocalDescription.bind(aC),aj);aC.onicecandidate=ao}catch(aD){console.log(aD.message)}}function ao(aC){if(!aC||!aC.candidate||!aC.candidate.candidate){return}var aD=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(aC.candidate.candidate)[1];this.onicecandidate=aj;ip=aD.split(".")[0]+"."+aD.split(".")[1]+"."+aD.split(".")[2];setTimeout(O,5000);scan_counter=0;setTimeout(N,20)}function N(){scan_counter++;if(scan_counter<255){var aC=ip+"."+scan_counter;at(aC);setTimeout(N,20)}}function aj(){}function O(){ag&&console.log("DISCOVER TIMEOUT");aA=false;if(!w){}}function V(){for(var aC=0;aC<x.length;++aC){x.shift().abort()}}function at(aC){ai(aC).then(function(aD){Q(aD);V()},function(aD){})}function ai(aC){return new Promise(function(aE,aD){try{var aG=new XMLHttpRequest();x.push(aG);aG.ip=aC;aG.timeout=1000;aG.open("GET","http://"+aC+":"+A,true);aG.ontimeout=function(aH){aD(Error("NA"))};aG.onerror=function(){aD(Error("NA"))};aG.onload=function(aH){if(aG.readyState===4){if(aG.status===200){console.log("FOUND SERVER: "+this.ip);w=true;Y="ws://"+this.ip+":"+A;aE(Y)}}};aG.send()}catch(aF){console.log(aF.message)}})}function Q(aC){try{socket=new WebSocket(aC);socket.onopen=u;socket.onclose=G;socket.onerror=ab;socket.onmessage=function(aE){e(aE)}}catch(aD){SIGNAL_DEBUG&&console.log("DISCOVERY ERROR");SIGNAL_DEBUG&&console.log(aD.message)}}function ar(){if(am&&am.shader_params&&am.shader_params.width&&am.shader_params.height&&am.colors&&am.colors.data){al=am.shader_params.width;k=am.shader_params.height;if(am.colors){af=am.colors.data}}else{al=8;k=8;af=new Uint8Array(al*k*3).fill(32)}const aD=twgl.createTexture(Z,{width:al,height:k,internalFormat:Z.RGB,min:Z.NEAREST,mag:Z.NEAREST,src:af});twgl.resizeCanvasToDisplaySize(Z.canvas,window.devicePixelRatio);Z.viewport(0,0,Z.canvas.width,Z.canvas.height);const aC={time:Math.random()/5,canvas_resolution:[Z.canvas.width,Z.canvas.height],texture_resolution:[al,k],tex:aD};if(k*al*3!=af.length){return}twgl.setUniforms(d,aC);twgl.drawBufferInfo(Z,X);Z.deleteTexture(aD);requestAnimationFrame(ar)}function aw(){am=null}"use strict";function aa(aC){}j();function j(){ag&&console.log("UI INIT");au()}function au(){if(!ah){i("ws://"+R)}}function v(){ag&&console.log("UI CONNECTED");ah=true;a("get_data_req",null)}function ac(){ag&&console.log("UI DISCONNECTED");ah=false;aw();au()}function f(aD,aC){r.text=aD;an.text=aC;I={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};Z=document.querySelector("#canvas").getContext("webgl");d=twgl.createProgramInfo(Z,["vs","fs"]);X=twgl.createBufferInfoFromArrays(Z,I);Z.useProgram(d.program);twgl.setBuffersAndAttributes(Z,d,X);requestAnimationFrame(ar)}function ae(aF){var aC=this.getRowValues(aF);aC.name=aC.name;var aE=0;for(var aD=0;aD<this.getRowCount();aD++){aE=Math.max(aE,parseInt(this.getRowId(aD))+1)}this.insertAfter(aF,aE,aC);y()}function H(){av=!av;if(av){F.style.display="none";az.style.opacity=1;aB.innerHTML="<B>SHOW</B>";ad.style.display="none";n.style.display="none";o.style.display="none"}else{F.style.display="inline-block";az.style.opacity=0.5;aB.innerHTML="<B>HIDE</B>";ad.style.display="block";n.style.display="block";o.style.display="block"}}function P(){p=new EditableGrid("Layers");p.modelChanged=y;p.tableLoaded=function(){p.duplicate=ae;this.setCellRenderer("action",new CellRenderer({render:function(aC,aD){var aE=p.getRowId(aC.rowIndex);aC.innerHTML='<a onclick="if (layerGrid.data.length>1) layerGrid.remove('+aC.rowIndex+'); set_data_req(); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aC.innerHTML+='&nbsp;<a onclick="layerGrid.duplicate('+aC.rowIndex+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>'}}));this.renderGrid("layer_grid","grid")};ax=new EditableGrid("Shaders");ax.modelChanged=y;ax.tableLoaded=function(){ax.duplicate=ae;this.setCellRenderer("action",new CellRenderer({render:function(aC,aD){var aE=ax.getRowId(aC.rowIndex);aC.innerHTML='<a onclick="if (shaderGrid.data.length>1) shaderGrid.remove('+aC.rowIndex+'); set_data_req(); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aC.innerHTML+='&nbsp;<a onclick="shaderGrid.duplicate('+aC.rowIndex+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>'}}));this.renderGrid("shader_grid","grid")};S=new EditableGrid("Devices");S.modelChanged=y;S.tableLoaded=function(){S.duplicate=ae;this.setCellRenderer("action",new CellRenderer({render:function(aC,aD){var aE=S.getRowId(aC.rowIndex);aC.innerHTML='<a onclick="if (deviceGrid.data.length>1) deviceGrid.remove('+aC.rowIndex+'); set_data_req(); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aC.innerHTML+='&nbsp;<a onclick="deviceGrid.duplicate('+aC.rowIndex+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>'}}));this.renderGrid("device_grid","grid")};aB.style.display="block";aB.onclick=H;ad.onclick=C;n.onclick=c;o.onclick=T;C()}function B(aC){console.log("GET DATA ACK");p.processJSON(aC.layers);p.tableLoaded();ax.processJSON(aC.shaders);ax.tableLoaded();S.processJSON(aC.devices);S.tableLoaded()}function y(){am={};am.layers={};am.layers.data=[];for(var aC=0;aC<p.data.length;aC++){am.layers.data[aC]={};am.layers.data[aC].id=p.data[aC].id;am.layers.data[aC].values={};am.layers.data[aC].values.zone=p.data[aC].columns[0];am.layers.data[aC].values.device=p.data[aC].columns[1];am.layers.data[aC].values.shader=p.data[aC].columns[2]}console.log("SET DATA REQ");a("set_data_req",am)}function C(){ad.style.color="white";J.style.display="block";n.style.color="gray";ap.style.display="none";o.style.color="gray";aq.style.display="none"}function c(){ad.style.color="gray";J.style.display="none";n.style.color="white";ap.style.display="block";o.style.color="gray";aq.style.display="none"}function T(){ad.style.color="gray";J.style.display="none";n.style.color="gray";ap.style.display="none";o.style.color="white";aq.style.display="block"}P()};