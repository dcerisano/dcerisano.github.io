function rgb_led_matrix_init(){var P=false,af=1,u=false,K=false,ab=1,V=null,ap=true,n=document.getElementById("canvas"),T=document.getElementById("ui"),ak=document.getElementById("menu"),c=document.getElementById("show_button"),t=document.getElementById("layer_button"),A=document.getElementById("shader_button"),N=document.getElementById("device_button"),m=document.getElementById("connect_button"),M=document.getElementById("fs"),x=document.getElementById("vs"),z=true,v=null,s=null,D=null,k=null,a=8,f=1,aa=0,q=0,J=0,an=0,Y=0,h=0,g=0,aj=null,o=null,e=null,G=false,ao=false,Q=[],X=8080,F=8443,d=[],b=null;function B(){P&&console.log("WEBSOCKET: CONNECT");if(ao&&websocket!=null){P&&console.log("WEBSOCKET: ATTEMPTING TO REUSE");p(websocket)}else{i()}}function ad(){P&&console.log("WEBSOCKET: OPEN");socket=this;w()}function O(ar){P&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+ar.data.toString());var aq=JSON.parse(ar.data.toString());var au=aq.method;var at=aq.params;switch(au){case"set_colors_ack":b=at;break;case"get_data_ack":get_data_ack(at);break;case"get_webgl_ack":Z(at.vertex_shader,at.fragment_shader);break;default:}}function H(aq){P&&console.log("WEBSOCKET: ONCLOSE");S()}function l(aq){P&&console.log("WEBSOCKET: ONERROR")}function i(){try{G=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var aq=new RTCPeerConnection({iceServers:[]});aq.createDataChannel("");aq.createOffer(aq.setLocalDescription.bind(aq),ag);aq.onicecandidate=W}catch(ar){console.log(ar.message)}}function W(aq){if(!aq||!aq.candidate||!aq.candidate.candidate){return}var ar=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(aq.candidate.candidate)[1];this.onicecandidate=ag;ip=ar.split(".")[0]+"."+ar.split(".")[1]+"."+ar.split(".")[2];setTimeout(U,5000);scan_counter=0;setTimeout(al,20)}function al(){scan_counter++;if(scan_counter<255){var aq=ip+"."+scan_counter;r(aq);setTimeout(al,20)}}function ag(){}function U(){P&&console.log("DISCOVER TIMEOUT");G=false;if(!ao){}}function E(){for(var aq=0;aq<Q.length;++aq){Q.shift().abort()}}function r(aq){ae(aq).then(function(ar){p(ar);E()},function(ar){})}function ae(aq){return new Promise(function(at,ar){try{var av=new XMLHttpRequest();Q.push(av);av.ip=aq;av.timeout=1000;av.open("GET","http://"+aq+":"+X,true);av.ontimeout=function(aw){ar(Error("NA"))};av.onerror=function(){ar(Error("NA"))};av.onload=function(aw){if(av.readyState===4){if(av.status===200){console.log("FOUND SERVER: "+this.ip);ao=true;at("ws://"+this.ip+":"+X)}}};av.send()}catch(au){"XHR:"+console.log(au.message)}})}function p(aq){console.log("DISCOVERED: "+aq);try{socket=new WebSocket(aq);socket.onopen=ad;socket.onclose=H;socket.onerror=l;socket.onmessage=function(at){O(at)}}catch(ar){SIGNAL_DEBUG&&console.log("DISCOVERY ERROR");SIGNAL_DEBUG&&console.log(ar.message)}}function y(){if(b&&b.shader_params&&b.shader_params.width&&b.shader_params.height&&b.colors&&b.colors.data){a=b.shader_params.width;f=b.shader_params.height;if(b.colors){V=b.colors.data}}else{a=8;f=8;V=new Uint8Array(a*f*3).fill(32)}const ar=twgl.createTexture(v,{width:a,height:f,internalFormat:v.RGB,min:v.NEAREST,mag:v.NEAREST,src:V});twgl.resizeCanvasToDisplaySize(v.canvas,window.devicePixelRatio);v.viewport(0,0,v.canvas.width,v.canvas.height);const aq={time:Math.random()/5,canvas_resolution:[v.canvas.width,v.canvas.height],texture_resolution:[a,f],tex:ar};if(f*a*3!=V.length){return}twgl.setUniforms(s,aq);twgl.drawBufferInfo(v,k);v.deleteTexture(ar);requestAnimationFrame(y)}function R(){b=null}function am(aq){}function L(){P&&console.log("UI INIT");C()}function C(){c.style.color="red";if(!K){B()}}function w(){P&&console.log("UI CONNECTED");K=true;c.style.color="green";socket_send("get_data_req",null)}function S(){P&&console.log("UI DISCONNECTED");z=false;ai();K=false;R();C()}function Z(ar,aq){x.text=ar;M.text=aq;D={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};v=document.querySelector("#canvas").getContext("webgl");s=twgl.createProgramInfo(v,["vs","fs"]);k=twgl.createBufferInfoFromArrays(v,D);v.useProgram(s.program);twgl.setBuffersAndAttributes(v,s,k);requestAnimationFrame(y)}function ai(){if(!K){return}z=!z;if(z){T.style.display="none";n.style.opacity=1;c.innerHTML="<B>Show</B>";t.style.display="none";A.style.display="none";N.style.display="none"}else{T.style.display="inline-block";n.style.opacity=0.5;c.innerHTML="<B>Hide</B>";t.style.display="block";A.style.display="block";N.style.display="block"}}function ac(){init_grids();c.style.display="block";c.onclick=ai;t.onclick=I;A.onclick=ah;N.onclick=j;I()}function I(){t.style.color="white";layer_grid.style.display="block";A.style.color="gray";shader_grid.style.display="none";N.style.color="gray";device_grid.style.display="none"}function ah(){t.style.color="gray";layer_grid.style.display="none";A.style.color="white";shader_grid.style.display="block";N.style.color="gray";device_grid.style.display="none"}function j(){t.style.color="gray";layer_grid.style.display="none";A.style.color="gray";shader_grid.style.display="none";N.style.color="white";device_grid.style.display="block"}ac();L()};