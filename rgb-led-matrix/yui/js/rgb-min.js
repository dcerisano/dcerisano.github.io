function rgb_led_matrix_init(){var T=false,ai=1,M=false,ad=1,X=null,ar=true,F=document.getElementById("server_name"),q=document.getElementById("canvas"),V=document.getElementById("ui"),an=document.getElementById("menu"),d=document.getElementById("show_button"),ae=document.getElementById("server_button"),w=document.getElementById("layer_button"),D=document.getElementById("shader_button"),Q=document.getElementById("device_button"),p=document.getElementById("connect_button"),O=document.getElementById("fs"),A=document.getElementById("vs"),C=true,at=null,x=null,v=null,G=null,n=null,a=8,g=1,ac=0,t=0,L=0,ap=0,aa=0,i=0,h=0,am=null,r=null,f=null,U=[],Z=8080,I=8443,e=[],c=[],W=0;function ag(){T&&console.log("WEBSOCKET: OPEN");z();this.send(json("get_webgl_req"));this.send(json("get_info_req"))}function S(aw){T&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+aw.data.toString());var av=servers.data[selected_server].values.address==new URL(aw.origin).hostname;var au=JSON.parse(aw.data.toString());var ay=au.method;var ax=au.params;switch(ay){case"discover_server_ack":P(ax);break;case"get_info_ack":y(ax);break;case"set_colors_ack":if(av){at=ax}break;case"get_data_ack":if(av){get_data_ack(ax)}break;case"get_webgl_ack":if(av){ab(ax.vertex_shader,ax.fragment_shader)}break;default:}}function J(au){T&&console.log("WEBSOCKET: ONCLOSE");data_close(new URL(this.url).hostname);R()}function o(au){T&&console.log("WEBSOCKET: ONERROR ")}function k(){try{discovering=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var au=new RTCPeerConnection({iceServers:[]});au.createDataChannel("");au.createOffer(au.setLocalDescription.bind(au),aj);au.onicecandidate=Y}catch(av){console.log(av.message)}}function aj(){}function Y(au){if(!au||!au.candidate||!au.candidate.candidate){return}var av=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(au.candidate.candidate)[1];this.onicecandidate=aj;ip=av.split(".")[0]+"."+av.split(".")[1]+"."+av.split(".")[2];scan_counter=0;setTimeout(ao,20)}function ao(){scan_counter++;if(scan_counter<255){var au=ip+"."+scan_counter;u(au);setTimeout(ao,20)}}function H(){for(var au=0;au<U.length;++au){U.shift().abort()}}function u(au){ah(au).then(function(av){s(av);H()},function(av){})}function ah(au){return new Promise(function(aw,av){try{var ay=new XMLHttpRequest();U.push(ay);ay.ip=au;ay.timeout=1000;ay.open("GET","http://"+au+":"+Z,true);ay.ontimeout=function(az){av(Error("NA"))};ay.onerror=function(){av(Error("NA"))};ay.onload=function(aA){if(ay.readyState===4){if(ay.status===200){console.log("FOUND SERVER: "+this.ip);var az={};az.ws="ws://"+this.ip+":"+Z;az.ip=this.ip;aw(az)}}};ay.send()}catch(ax){"XHR:"+console.log(ax.message)}})}function s(aw){try{var au=new WebSocket(aw.ws);au.onopen=ag;au.onclose=J;au.onerror=o;au.onmessage=S;var ax=false;if(W>0){for(var av=0;av<W;av++){if(aw.ip===servers.data[av].values.address){console.log("FOUND "+aw.ip);servers.data[av].socket=au;if(selected_server==-1){selected_server=av}ax=true}}}if(selected_server==-1){selected_server=0}if(!ax){servers.data[W]={};servers.data[W].socket=au;servers.data[W].id=W+1;servers.data[W].values={};servers.data[W].values.address=aw.ip;if(W==0){servers.data[W].values.selected=true}W++}else{servers.data[selected_server].values.selected=true;R();serverGrid.processJSON(servers);serverGrid.tableLoaded()}}catch(ay){console.log("DISCOVERY ERROR");console.log(ay.message)}}function y(av){for(var au=0;au<W;au++){if(av.ip===servers.data[au].values.address){servers.data[au].values.hostname=av.hostname;servers.data[au].values.platform=av.platform;servers.data[au].values.status=av.status}}R();serverGrid.processJSON(servers);serverGrid.tableLoaded()}function P(av){var au={};au.ws="ws://"+av.ip+":"+Z;au.ip=av.ip;s(au)}function z(){socket_send(selected_server,"get_data_req",null);M=true}function E(){if(!M){k()}console.log(M)}setInterval(E,5000);function B(){if(at&&at.width&&at.height&&at.colors&&at.colors.data){X=at.colors.data;const av=twgl.createTexture(x,{width:at.width,height:at.height,internalFormat:x.RGB,min:x.NEAREST,mag:x.NEAREST,src:X});twgl.resizeCanvasToDisplaySize(x.canvas,window.devicePixelRatio);x.viewport(0,0,x.canvas.width,x.canvas.height);const au={time:Math.random()/5,canvas_resolution:[x.canvas.width,x.canvas.height],texture_resolution:[at.width,at.height],tex:av};twgl.setUniforms(v,au);twgl.drawBufferInfo(x,n);x.deleteTexture(av)}requestAnimationFrame(B)}function N(){T&&console.log("UI INIT");E()}function E(){d.style.color="red";if(!M){k()}}function z(){T&&console.log("UI CONNECTED");M=true;d.style.color="green";socket_send(selected_server,"get_data_req",null)}function ab(av,au){A.text=av;O.text=au;G={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};x=document.querySelector("#canvas").getContext("webgl");v=twgl.createProgramInfo(x,["vs","fs"]);n=twgl.createBufferInfoFromArrays(x,G);x.useProgram(v.program);twgl.setBuffersAndAttributes(x,v,n);requestAnimationFrame(B)}function al(){C=!C;if(C){V.style.display="none";q.style.opacity=1;d.innerHTML="<B>Show</B>";ae.style.display="none";w.style.display="none";D.style.display="none";Q.style.display="none";server_config.style.display="none"}else{V.style.display="inline-block";q.style.opacity=0.5;d.innerHTML="<B>Hide</B>";ae.style.display="block";w.style.display="block";D.style.display="block";Q.style.display="block";server_config.style.display="flex"}}function af(){var au=document.createElement("option");au.text="None";server_menu.add(au);init_grids();d.style.display="block";d.onclick=al;ae.onclick=j;w.onclick=K;D.onclick=ak;Q.onclick=l;server_menu.onchange=m;C=true;al();j()}function j(){ae.style.color="white";server_grid.style.display="block";w.style.color="gray";layer_grid.style.display="none";D.style.color="gray";shader_grid.style.display="none";Q.style.color="gray";device_grid.style.display="none"}function K(){ae.style.color="gray";server_grid.style.display="none";w.style.color="white";layer_grid.style.display="block";D.style.color="gray";shader_grid.style.display="none";Q.style.color="gray";device_grid.style.display="none"}function ak(){ae.style.color="gray";server_grid.style.display="none";D.style.color="white";shader_grid.style.display="block";w.style.color="gray";layer_grid.style.display="none";Q.style.color="gray";device_grid.style.display="none"}function l(){ae.style.color="gray";server_grid.style.display="none";w.style.color="gray";layer_grid.style.display="none";D.style.color="gray";shader_grid.style.display="none";Q.style.color="white";device_grid.style.display="block"}function b(aw,av){var au;au='<a onclick="if ('+aw.name+".data.length>1) "+aw.name+".remove("+av+'); set_data_req(); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';au+='&nbsp;<a onclick="'+aw.name+".duplicate("+av+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>';return au}function aq(ax,aw){var av;var au="closed";if(servers.data[aw].values.status=="UP"){au="open"}av='&nbsp;<a style="cursor:pointer"><img src="img/'+au+'.png" border="0" alt="connect" title="Reconnect"/></a>';return av}function m(){serverChanged(server_menu.selectedIndex,0,false,true,null)}function R(){server_menu.innerText=null;if(!M){var av=document.createElement("option");av.text="None";server_menu.add(av)}else{for(var au=0;au<W;au++){var av=document.createElement("option");av.text=servers.data[au].values.hostname;server_menu.add(av)}server_menu.selectedIndex=selected_server}}af();N()};