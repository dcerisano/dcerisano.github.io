var layerGrid={};var shaderGrid={};var deviceGrid={};function rgb_led_matrix_init(){var ag=false,R="localhost:8080",Y=null,n=1,K=false,ah=false,T=1,af=null,b=true,ay=document.getElementById("canvas"),F=document.getElementById("ui"),m=document.getElementById("menu"),aA=document.getElementById("show_button"),ad=document.getElementById("layer_button"),o=document.getElementById("shader_button"),p=document.getElementById("device_button"),c=document.getElementById("connect_button"),J=document.getElementById("layer_grid"),ap=document.getElementById("shader_grid"),aq=document.getElementById("device_grid"),an=document.getElementById("fs"),r=document.getElementById("vs"),av=true,Z=null,e=null,I=null,X=null,al=8,l=1,D=0,E=0,h=0,s=0,t=0,W=0,L=0,i=null,ax=null,ak=null,az=false,w=false,x=[],A=8080,q=8443,Y=null,am=null;function j(aB){ag&&console.log("WEBSOCKET: CONNECT");if(w&&Y!=null){ag&&console.log("WEBSOCKET: ATTEMPTING TO REUSE");Q(Y)}else{z()}}function u(){ag&&console.log("WEBSOCKET: OPEN");socket=this;v()}function f(aC){ag&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+aC.data.toString());var aB=JSON.parse(aC.data.toString());var aE=aB.method;var aD=aB.params;switch(aE){case"set_colors_ack":am=aD;break;case"get_data_ack":B(aD);break;case"get_webgl_ack":g(aD.vertex_shader,aD.fragment_shader);break;default:}}function G(aB){ag&&console.log("WEBSOCKET: ONCLOSE");ac()}function ab(aB){ag&&console.log("WEBSOCKET: ONERROR")}function a(aC,aB){ag&&console.log("WEBSOCKET: SENT MESSAGE TO SERVER: "+M(aC,aB));if(socket.readyState===socket.OPEN){socket.send(M(aC,aB))}}function M(aD,aC){var aB={method:aD,params:aC};console.log(JSON.stringify(aB));return JSON.stringify(aB)}function z(){try{az=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var aB=new RTCPeerConnection({iceServers:[]});aB.createDataChannel("");aB.createOffer(aB.setLocalDescription.bind(aB),aj);aB.onicecandidate=ao}catch(aC){console.log(aC.message)}}function ao(aB){if(!aB||!aB.candidate||!aB.candidate.candidate){return}var aC=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(aB.candidate.candidate)[1];this.onicecandidate=aj;ip=aC.split(".")[0]+"."+aC.split(".")[1]+"."+aC.split(".")[2];setTimeout(O,5000);scan_counter=0;setTimeout(N,20)}function N(){scan_counter++;if(scan_counter<255){var aB=ip+"."+scan_counter;at(aB);setTimeout(N,20)}}function aj(){}function O(){ag&&console.log("DISCOVER TIMEOUT");az=false;if(!w){}}function V(){for(var aB=0;aB<x.length;++aB){x.shift().abort()}}function at(aB){ai(aB).then(function(aC){Q(aC);V()},function(aC){})}function ai(aB){return new Promise(function(aD,aC){try{var aF=new XMLHttpRequest();x.push(aF);aF.ip=aB;aF.timeout=1000;aF.open("GET","http://"+aB+":"+A,true);aF.ontimeout=function(aG){aC(Error("NA"))};aF.onerror=function(){aC(Error("NA"))};aF.onload=function(aG){if(aF.readyState===4){if(aF.status===200){console.log("FOUND SERVER: "+this.ip);w=true;Y="ws://"+this.ip+":"+A;aD(Y)}}};aF.send()}catch(aE){"XHR:"+console.log(aE.message)}})}function Q(aB){try{socket=new WebSocket(aB);socket.onopen=u;socket.onclose=G;socket.onerror=ab;socket.onmessage=function(aD){f(aD)}}catch(aC){SIGNAL_DEBUG&&console.log("DISCOVERY ERROR");SIGNAL_DEBUG&&console.log(aC.message)}}function ar(){if(am&&am.shader_params&&am.shader_params.width&&am.shader_params.height&&am.colors&&am.colors.data){al=am.shader_params.width;l=am.shader_params.height;if(am.colors){af=am.colors.data}}else{al=8;l=8;af=new Uint8Array(al*l*3).fill(32)}const aC=twgl.createTexture(Z,{width:al,height:l,internalFormat:Z.RGB,min:Z.NEAREST,mag:Z.NEAREST,src:af});twgl.resizeCanvasToDisplaySize(Z.canvas,window.devicePixelRatio);Z.viewport(0,0,Z.canvas.width,Z.canvas.height);const aB={time:Math.random()/5,canvas_resolution:[Z.canvas.width,Z.canvas.height],texture_resolution:[al,l],tex:aC};if(l*al*3!=af.length){return}twgl.setUniforms(e,aB);twgl.drawBufferInfo(Z,X);Z.deleteTexture(aC);requestAnimationFrame(ar)}function aw(){am=null}function aa(aB){}k();function k(){ag&&console.log("UI INIT");au()}function au(){aA.style.color="red";if(!ah){j("ws://"+R)}}function v(){ag&&console.log("UI CONNECTED");ah=true;aA.style.color="green";a("get_data_req",null)}function ac(){ag&&console.log("UI DISCONNECTED");ah=false;aw();au()}function g(aC,aB){r.text=aC;an.text=aB;I={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};Z=document.querySelector("#canvas").getContext("webgl");e=twgl.createProgramInfo(Z,["vs","fs"]);X=twgl.createBufferInfoFromArrays(Z,I);Z.useProgram(e.program);twgl.setBuffersAndAttributes(Z,e,X);requestAnimationFrame(ar)}function ae(aE){var aB=this.getRowValues(aE);aB.name=aB.name;var aD=0;for(var aC=0;aC<this.getRowCount();aC++){aD=Math.max(aD,parseInt(this.getRowId(aC))+1)}this.insertAfter(aE,aD,aB);y()}function H(){av=!av;if(av){F.style.display="none";ay.style.opacity=1;aA.innerHTML="<B>SHOW</B>";ad.style.display="none";o.style.display="none";p.style.display="none"}else{F.style.display="inline-block";ay.style.opacity=0.5;aA.innerHTML="<B>HIDE</B>";ad.style.display="block";o.style.display="block";p.style.display="block"}}function P(){layerGrid=new EditableGrid("layerGrid");console.log(layerGrid.name);layerGrid.modelChanged=y;layerGrid.tableLoaded=function(){layerGrid.duplicate=ae;this.setCellRenderer("action",new CellRenderer({render:function(aB,aC){aB.innerHTML=U(layerGrid,aB.rowIndex)}}));this.renderGrid("layer_grid","grid")};shaderGrid=new EditableGrid("shaderGrid");shaderGrid.modelChanged=y;shaderGrid.tableLoaded=function(){shaderGrid.duplicate=ae;this.setCellRenderer("action",new CellRenderer({render:function(aB,aC){aB.innerHTML=U(shaderGrid,aB.rowIndex)}}));this.renderGrid("shader_grid","grid")};deviceGrid=new EditableGrid("deviceGrid");deviceGrid.modelChanged=y;deviceGrid.tableLoaded=function(){deviceGrid.duplicate=ae;this.setCellRenderer("action",new CellRenderer({render:function(aB,aC){aB.innerHTML=U(deviceGrid,aB.rowIndex)}}));this.renderGrid("device_grid","grid")};aA.style.display="block";aA.onclick=H;ad.onclick=C;o.onclick=d;p.onclick=S;C()}function U(aD,aC){var aB;aB='<a onclick="if ('+layerGrid.name+".data.length>1) "+layerGrid.name+".remove("+aC+"); "+y.name+'(); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aB+='&nbsp;<a onclick="'+layerGrid.name+".duplicate("+aC+');" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>';return aB}function B(aB){console.log("GET DATA ACK");layerGrid.processJSON(aB.layers);layerGrid.tableLoaded();shaderGrid.processJSON(aB.shaders);shaderGrid.tableLoaded();deviceGrid.processJSON(aB.devices);deviceGrid.tableLoaded()}function y(){am={};am.layers={};am.layers.data=[];for(var aB=0;aB<layerGrid.data.length;aB++){am.layers.data[aB]={};am.layers.data[aB].id=layerGrid.data[aB].id;am.layers.data[aB].values={};am.layers.data[aB].values.zone=layerGrid.data[aB].columns[0];am.layers.data[aB].values.device=layerGrid.data[aB].columns[1];am.layers.data[aB].values.shader=layerGrid.data[aB].columns[2]}console.log("SET DATA REQ");a("set_data_req",am)}function C(){ad.style.color="white";J.style.display="block";o.style.color="gray";ap.style.display="none";p.style.color="gray";aq.style.display="none"}function d(){ad.style.color="gray";J.style.display="none";o.style.color="white";ap.style.display="block";p.style.color="gray";aq.style.display="none"}function S(){ad.style.color="gray";J.style.display="none";o.style.color="gray";ap.style.display="none";p.style.color="white";aq.style.display="block"}P()};