function rgb_led_matrix_init(){var Q=false,ah=1,v=false,L=false,ac=1,W=null,ar=true,o=document.getElementById("canvas"),U=document.getElementById("ui"),am=document.getElementById("menu"),c=document.getElementById("show_button"),ad=document.getElementById("server_button"),u=document.getElementById("layer_button"),B=document.getElementById("shader_button"),O=document.getElementById("device_button"),n=document.getElementById("connect_button"),N=document.getElementById("fs"),y=document.getElementById("vs"),A=true,w=null,t=null,E=null,l=null,a=8,f=1,ab=0,r=0,K=0,ap=0,Z=0,h=0,g=0,al=null,p=null,e=null,H=false,aq=false,R=[],Y=8080,G=8443,d=[],b=null;function C(){Q&&console.log("WEBSOCKET: CONNECT");if(aq&&websocket!=null){Q&&console.log("WEBSOCKET: ATTEMPTING TO REUSE");q(websocket)}else{j()}}function af(){Q&&console.log("WEBSOCKET: OPEN");socket=this;x()}function P(au){Q&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+au.data.toString());var at=JSON.parse(au.data.toString());var aw=at.method;var av=at.params;switch(aw){case"set_colors_ack":b=av;break;case"get_data_ack":get_data_ack(av);break;case"get_webgl_ack":aa(av.vertex_shader,av.fragment_shader);break;default:}}function I(at){Q&&console.log("WEBSOCKET: ONCLOSE");T()}function m(at){Q&&console.log("WEBSOCKET: ONERROR")}function j(){try{H=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var at=new RTCPeerConnection({iceServers:[]});at.createDataChannel("");at.createOffer(at.setLocalDescription.bind(at),ai);at.onicecandidate=X}catch(au){console.log(au.message)}}function X(at){if(!at||!at.candidate||!at.candidate.candidate){return}var au=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(at.candidate.candidate)[1];this.onicecandidate=ai;ip=au.split(".")[0]+"."+au.split(".")[1]+"."+au.split(".")[2];setTimeout(V,5000);scan_counter=0;setTimeout(an,20)}function an(){scan_counter++;if(scan_counter<255){var at=ip+"."+scan_counter;s(at);setTimeout(an,20)}}function ai(){}function V(){Q&&console.log("DISCOVER TIMEOUT");H=false;if(!aq){}}function F(){for(var at=0;at<R.length;++at){R.shift().abort()}}function s(at){ag(at).then(function(au){q(au);F()},function(au){})}function ag(at){return new Promise(function(av,au){try{var ax=new XMLHttpRequest();R.push(ax);ax.ip=at;ax.timeout=1000;ax.open("GET","http://"+at+":"+Y,true);ax.ontimeout=function(ay){au(Error("NA"))};ax.onerror=function(){au(Error("NA"))};ax.onload=function(ay){if(ax.readyState===4){if(ax.status===200){console.log("FOUND SERVER: "+this.ip);aq=true;av("ws://"+this.ip+":"+Y)}}};ax.send()}catch(aw){"XHR:"+console.log(aw.message)}})}function q(at){console.log("DISCOVERED: "+at);try{socket=new WebSocket(at);socket.onopen=af;socket.onclose=I;socket.onerror=m;socket.onmessage=function(av){P(av)}}catch(au){SIGNAL_DEBUG&&console.log("DISCOVERY ERROR");SIGNAL_DEBUG&&console.log(au.message)}}function z(){if(b&&b.shader_params&&b.shader_params.width&&b.shader_params.height&&b.colors&&b.colors.data){a=b.shader_params.width;f=b.shader_params.height;if(b.colors){W=b.colors.data}}else{a=8;f=8;W=new Uint8Array(a*f*3).fill(32)}const au=twgl.createTexture(w,{width:a,height:f,internalFormat:w.RGB,min:w.NEAREST,mag:w.NEAREST,src:W});twgl.resizeCanvasToDisplaySize(w.canvas,window.devicePixelRatio);w.viewport(0,0,w.canvas.width,w.canvas.height);const at={time:Math.random()/5,canvas_resolution:[w.canvas.width,w.canvas.height],texture_resolution:[a,f],tex:au};if(f*a*3!=W.length){return}twgl.setUniforms(t,at);twgl.drawBufferInfo(w,l);w.deleteTexture(au);requestAnimationFrame(z)}function S(){b=null}function ao(at){}function M(){Q&&console.log("UI INIT");D()}function D(){c.style.color="red";if(!L){C()}}function x(){Q&&console.log("UI CONNECTED");L=true;c.style.color="green";socket_send("get_data_req",null)}function T(){Q&&console.log("UI DISCONNECTED");A=false;ak();L=false;S();D()}function aa(au,at){y.text=au;N.text=at;E={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};w=document.querySelector("#canvas").getContext("webgl");t=twgl.createProgramInfo(w,["vs","fs"]);l=twgl.createBufferInfoFromArrays(w,E);w.useProgram(t.program);twgl.setBuffersAndAttributes(w,t,l);requestAnimationFrame(z)}function ak(){if(!L){return}A=!A;if(A){U.style.display="none";o.style.opacity=1;c.innerHTML="<B>Show</B>";ad.style.display="none";u.style.display="none";B.style.display="none";O.style.display="none"}else{U.style.display="inline-block";o.style.opacity=0.5;c.innerHTML="<B>Hide</B>";ad.style.display="block";u.style.display="block";B.style.display="block";O.style.display="block"}}function ae(){init_grids();c.style.display="block";c.onclick=ak;ad.onclick=i;u.onclick=J;B.onclick=aj;O.onclick=k;i()}function i(){ad.style.color="white";server_grid.style.display="block";u.style.color="gray";layer_grid.style.display="none";B.style.color="gray";shader_grid.style.display="none";O.style.color="gray";device_grid.style.display="none"}function J(){u.style.color="white";layer_grid.style.display="block";ad.style.color="gray";server_grid.style.display="none";B.style.color="gray";shader_grid.style.display="none";O.style.color="gray";device_grid.style.display="none"}function aj(){B.style.color="white";shader_grid.style.display="block";u.style.color="gray";layer_grid.style.display="none";O.style.color="gray";device_grid.style.display="none"}function k(){ad.style.color="gray";server_grid.style.display="none";u.style.color="gray";layer_grid.style.display="none";B.style.color="gray";shader_grid.style.display="none";O.style.color="white";device_grid.style.display="block"}ae();M()};