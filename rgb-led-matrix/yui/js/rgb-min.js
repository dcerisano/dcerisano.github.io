function rgb_led_matrix_init(){var Q=false,ai=1,v=false,L=false,ad=1,X=null,at=true,o=document.getElementById("canvas"),U=document.getElementById("ui"),an=document.getElementById("menu"),c=document.getElementById("show_button"),ae=document.getElementById("server_button"),u=document.getElementById("layer_button"),B=document.getElementById("shader_button"),O=document.getElementById("device_button"),n=document.getElementById("connect_button"),N=document.getElementById("fs"),y=document.getElementById("vs"),A=true,w=null,t=null,E=null,l=null,a=8,f=1,ac=0,r=0,K=0,aq=0,aa=0,h=0,g=0,am=null,p=null,e=null,H=false,ar=false,R=[],Z=8080,G=8443,d=[],b=null,W=0;function C(){Q&&console.log("WEBSOCKET: CONNECT");if(ar&&websocket!=null){Q&&console.log("WEBSOCKET: ATTEMPTING TO REUSE");q(websocket)}else{j()}}function ag(){Q&&console.log("WEBSOCKET: OPEN");socket=this;x()}function P(av){Q&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+av.data.toString());var au=JSON.parse(av.data.toString());var ax=au.method;var aw=au.params;switch(ax){case"set_colors_ack":b=aw;break;case"get_data_ack":get_data_ack(aw);break;case"get_webgl_ack":ab(aw.vertex_shader,aw.fragment_shader);break;default:}}function I(au){Q&&console.log("WEBSOCKET: ONCLOSE");T()}function m(au){Q&&console.log("WEBSOCKET: ONERROR")}function j(){try{H=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var au=new RTCPeerConnection({iceServers:[]});au.createDataChannel("");au.createOffer(au.setLocalDescription.bind(au),aj);au.onicecandidate=Y}catch(av){console.log(av.message)}}function Y(au){if(!au||!au.candidate||!au.candidate.candidate){return}var av=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(au.candidate.candidate)[1];this.onicecandidate=aj;ip=av.split(".")[0]+"."+av.split(".")[1]+"."+av.split(".")[2];setTimeout(V,5000);scan_counter=0;setTimeout(ao,20)}function ao(){scan_counter++;if(scan_counter<255){var au=ip+"."+scan_counter;s(au);setTimeout(ao,20)}}function aj(){}function V(){Q&&console.log("DISCOVER TIMEOUT");H=false;if(!ar){}}function F(){for(var au=0;au<R.length;++au){R.shift().abort()}}function s(au){ah(au).then(function(av){q(av);F()},function(av){})}function ah(au){return new Promise(function(aw,av){try{var ay=new XMLHttpRequest();R.push(ay);ay.ip=au;ay.timeout=1000;ay.open("GET","http://"+au+":"+Z,true);ay.ontimeout=function(az){av(Error("NA"))};ay.onerror=function(){av(Error("NA"))};ay.onload=function(aA){if(ay.readyState===4){if(ay.status===200){console.log("FOUND SERVER: "+this.ip);ar=true;var az={};az.ws="ws://"+this.ip+":"+Z;az.ip=this.ip;aw(az)}}};ay.send()}catch(ax){"XHR:"+console.log(ax.message)}})}function q(au){servers.data[W]={};servers.data[W].id=W+1;servers.data[W].values={};servers.data[W].values.address=au.ip;W++;try{socket=new WebSocket(au.ws);socket.onopen=ag;socket.onclose=I;socket.onerror=m;socket.onmessage=function(aw){P(aw)}}catch(av){SIGNAL_DEBUG&&console.log("DISCOVERY ERROR");SIGNAL_DEBUG&&console.log(av.message)}}function z(){if(b&&b.shader_params&&b.shader_params.width&&b.shader_params.height&&b.colors&&b.colors.data){a=b.shader_params.width;f=b.shader_params.height;if(b.colors){X=b.colors.data}}else{a=8;f=8;X=new Uint8Array(a*f*3).fill(32)}const av=twgl.createTexture(w,{width:a,height:f,internalFormat:w.RGB,min:w.NEAREST,mag:w.NEAREST,src:X});twgl.resizeCanvasToDisplaySize(w.canvas,window.devicePixelRatio);w.viewport(0,0,w.canvas.width,w.canvas.height);const au={time:Math.random()/5,canvas_resolution:[w.canvas.width,w.canvas.height],texture_resolution:[a,f],tex:av};if(f*a*3!=X.length){return}twgl.setUniforms(t,au);twgl.drawBufferInfo(w,l);w.deleteTexture(av);requestAnimationFrame(z)}function S(){b=null}function ap(au){}function M(){Q&&console.log("UI INIT");D()}function D(){c.style.color="red";if(!L){C()}}function x(){Q&&console.log("UI CONNECTED");L=true;c.style.color="green";socket_send("get_data_req",null)}function T(){Q&&console.log("UI DISCONNECTED");A=false;al();L=false;S();D()}function ab(av,au){y.text=av;N.text=au;E={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};w=document.querySelector("#canvas").getContext("webgl");t=twgl.createProgramInfo(w,["vs","fs"]);l=twgl.createBufferInfoFromArrays(w,E);w.useProgram(t.program);twgl.setBuffersAndAttributes(w,t,l);requestAnimationFrame(z)}function al(){if(!L){return}A=!A;if(A){U.style.display="none";o.style.opacity=1;c.innerHTML="<B>Show</B>";ae.style.display="none";u.style.display="none";B.style.display="none";O.style.display="none"}else{U.style.display="inline-block";o.style.opacity=0.5;c.innerHTML="<B>Hide</B>";ae.style.display="block";u.style.display="block";B.style.display="block";O.style.display="block"}}function af(){init_grids();c.style.display="block";c.onclick=al;ae.onclick=i;u.onclick=J;B.onclick=ak;O.onclick=k;i()}function i(){ae.style.color="white";server_grid.style.display="block";u.style.color="gray";layer_grid.style.display="none";B.style.color="gray";shader_grid.style.display="none";O.style.color="gray";device_grid.style.display="none"}function J(){u.style.color="white";layer_grid.style.display="block";ae.style.color="gray";server_grid.style.display="none";B.style.color="gray";shader_grid.style.display="none";O.style.color="gray";device_grid.style.display="none"}function ak(){B.style.color="white";shader_grid.style.display="block";u.style.color="gray";layer_grid.style.display="none";O.style.color="gray";device_grid.style.display="none"}function k(){ae.style.color="gray";server_grid.style.display="none";u.style.color="gray";layer_grid.style.display="none";B.style.color="gray";shader_grid.style.display="none";O.style.color="white";device_grid.style.display="block"}af();M()};