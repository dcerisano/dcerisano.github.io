function rgb_led_matrix_init(){var af=false,m=1,M=false,ag=false,U=1,ae=null,b=true,aw=document.getElementById("canvas"),H=document.getElementById("ui"),l=document.getElementById("menu"),ay=document.getElementById("show_button"),ad=document.getElementById("server_button"),ac=document.getElementById("layer_button"),n=document.getElementById("shader_button"),o=document.getElementById("device_button"),c=document.getElementById("connect_button"),am=document.getElementById("fs"),q=document.getElementById("vs"),ar=true,Y=null,e=null,K=null,X=null,ak=8,k=1,F=0,G=0,h=0,s=0,t=0,W=0,N=0,i=null,av=null,aj=null,ax=false,w=false,y=[],C=8080,p=8443,z=[],al=null,r=[],x=0,B=0;function D(){af&&console.log("WEBSOCKET: CONNECT");if(w&&websocket!=null){af&&console.log("WEBSOCKET: ATTEMPTING TO REUSE");S(websocket)}else{A()}}function u(){af&&console.log("WEBSOCKET: OPEN");v();this.send(O("get_webgl_req"));this.send(O("get_info_req"))}function f(aB){af&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+aB.data.toString());var aA=(servers.data[B].values.address==new URL(aB.origin).hostname);var az=JSON.parse(aB.data.toString());var aD=az.method;var aC=az.params;switch(aD){case"get_info_ack":L(aC);break;case"set_colors_ack":if(aA){al=aC}break;case"get_data_ack":if(aA){get_data_ack(aC)}break;case"get_webgl_ack":if(aA){g(aC.vertex_shader,aC.fragment_shader)}break;default:}}function I(az){af&&console.log("WEBSOCKET: ONCLOSE");ab()}function aa(az){af&&console.log("WEBSOCKET: ONERROR")}function a(az,aB,aA){af&&console.log("WEBSOCKET: SENT MESSAGE TO SERVER: "+O(aB,aA));if(r.readyState===r.OPEN){servers.data[az].socket.send(O(aB,aA))}}function O(aB,aA){var az={method:aB,params:aA};return JSON.stringify(az)}function A(){try{ax=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var az=new RTCPeerConnection({iceServers:[]});az.createDataChannel("");az.createOffer(az.setLocalDescription.bind(az),ai);az.onicecandidate=an}catch(aA){console.log(aA.message)}}function an(az){if(!az||!az.candidate||!az.candidate.candidate){return}var aA=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(az.candidate.candidate)[1];this.onicecandidate=ai;ip=aA.split(".")[0]+"."+aA.split(".")[1]+"."+aA.split(".")[2];setTimeout(Q,5000);scan_counter=0;setTimeout(P,20)}function P(){scan_counter++;if(scan_counter<255){var az=ip+"."+scan_counter;ap(az);setTimeout(P,20)}}function ai(){}function Q(){af&&console.log("DISCOVER TIMEOUT");ax=false;if(!w){}}function V(){for(var az=0;az<y.length;++az){y.shift().abort()}}function ap(az){ah(az).then(function(aA){S(aA);V()},function(aA){})}function ah(az){return new Promise(function(aB,aA){try{var aD=new XMLHttpRequest();y.push(aD);aD.ip=az;aD.timeout=1000;aD.open("GET","http://"+az+":"+C,true);aD.ontimeout=function(aE){aA(Error("NA"))};aD.onerror=function(){aA(Error("NA"))};aD.onload=function(aF){if(aD.readyState===4){if(aD.status===200){console.log("FOUND SERVER: "+this.ip);w=true;var aE={};aE.ws="ws://"+this.ip+":"+C;aE.ip=this.ip;aB(aE)}}};aD.send()}catch(aC){"XHR:"+console.log(aC.message)}})}function S(aA){try{var az=new WebSocket(aA.ws);az.onopen=u;az.onclose=I;az.onerror=aa;az.onmessage=function(aC){f(aC)};servers.data[x]={};servers.data[x].socket=az;servers.data[x].id=x+1;servers.data[x].values={};servers.data[x].values.address=aA.ip;x++}catch(aB){console.log("DISCOVERY ERROR");console.log(aB.message)}}function L(aA){for(var az=0;az<x;az++){if(aA.ip===servers.data[az].values.address){servers.data[az].values.hostname=aA.hostname;servers.data[az].values.platform=aA.platform;servers.data[az].values.status=aA.status}}serverGrid.processJSON(servers);serverGrid.tableLoaded()}function ao(){if(al&&al.shader_params&&al.shader_params.width&&al.shader_params.height&&al.colors&&al.colors.data){ak=al.shader_params.width;k=al.shader_params.height;if(al.colors&&ak*k*3==al.colors.data.length){ae=al.colors.data}}else{ak=8;k=8;ae=new Uint8Array(ak*k*3).fill(32)}const aA=twgl.createTexture(Y,{width:ak,height:k,internalFormat:Y.RGB,min:Y.NEAREST,mag:Y.NEAREST,src:ae});twgl.resizeCanvasToDisplaySize(Y.canvas,window.devicePixelRatio);Y.viewport(0,0,Y.canvas.width,Y.canvas.height);const az={time:Math.random()/5,canvas_resolution:[Y.canvas.width,Y.canvas.height],texture_resolution:[ak,k],tex:aA};if(k*ak*3!=ae.length){return}twgl.setUniforms(e,az);twgl.drawBufferInfo(Y,X);Y.deleteTexture(aA);requestAnimationFrame(ao)}function au(){al=null}function Z(az){}function j(){af&&console.log("UI INIT");aq()}function aq(){ay.style.color="red";if(!ag){D()}}function v(){af&&console.log("UI CONNECTED");ag=true;ay.style.color="green";a(B,"get_data_req",null)}function ab(){af&&console.log("UI DISCONNECTED");ar=false;J();ag=false;au();aq()}function g(aA,az){q.text=aA;am.text=az;K={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};Y=document.querySelector("#canvas").getContext("webgl");e=twgl.createProgramInfo(Y,["vs","fs"]);X=twgl.createBufferInfoFromArrays(Y,K);Y.useProgram(e.program);twgl.setBuffersAndAttributes(Y,e,X);requestAnimationFrame(ao)}function J(){if(!ag){return}ar=!ar;if(ar){H.style.display="none";aw.style.opacity=1;ay.innerHTML="<B>Show</B>";ad.style.display="none";ac.style.display="none";n.style.display="none";o.style.display="none"}else{H.style.display="inline-block";aw.style.opacity=0.5;ay.innerHTML="<B>Hide</B>";ad.style.display="block";ac.style.display="block";n.style.display="block";o.style.display="block"}}function R(){init_grids();ay.style.display="block";ay.onclick=J;ad.onclick=at;ac.onclick=E;n.onclick=d;o.onclick=T;at()}function at(){ad.style.color="white";server_grid.style.display="block";ac.style.color="gray";layer_grid.style.display="none";n.style.color="gray";shader_grid.style.display="none";o.style.color="gray";device_grid.style.display="none"}function E(){ac.style.color="white";layer_grid.style.display="block";ad.style.color="gray";server_grid.style.display="none";n.style.color="gray";shader_grid.style.display="none";o.style.color="gray";device_grid.style.display="none"}function d(){n.style.color="white";shader_grid.style.display="block";ac.style.color="gray";layer_grid.style.display="none";o.style.color="gray";device_grid.style.display="none"}function T(){ad.style.color="gray";server_grid.style.display="none";ac.style.color="gray";layer_grid.style.display="none";n.style.color="gray";shader_grid.style.display="none";o.style.color="white";device_grid.style.display="block"}R();j()};