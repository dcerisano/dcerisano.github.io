function rgb_led_matrix_init(){var af=false,m=1,M=false,ag=false,U=1,ae=null,b=true,aj=document.getElementById("server_name"),ax=document.getElementById("canvas"),H=document.getElementById("ui"),l=document.getElementById("menu"),az=document.getElementById("show_button"),ad=document.getElementById("server_button"),ac=document.getElementById("layer_button"),n=document.getElementById("shader_button"),o=document.getElementById("device_button"),c=document.getElementById("connect_button"),an=document.getElementById("fs"),q=document.getElementById("vs"),at=true,Y=null,e=null,K=null,X=null,al=8,k=1,F=0,G=0,h=0,s=0,t=0,W=0,N=0,i=null,aw=null,ak=null,ay=false,w=false,y=[],C=8080,p=8443,z=[],am=null,r=[],x=0,B=0;function D(){af&&console.log("WEBSOCKET: CONNECT");if(w&&websocket!=null){af&&console.log("WEBSOCKET: ATTEMPTING TO REUSE");S(websocket)}else{A()}}function u(){af&&console.log("WEBSOCKET: OPEN");v();this.send(O("get_webgl_req"));this.send(O("get_info_req"))}function f(aC){af&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+aC.data.toString());var aB=(servers.data[B].values.address==new URL(aC.origin).hostname);var aA=JSON.parse(aC.data.toString());var aE=aA.method;var aD=aA.params;switch(aE){case"get_info_ack":L(aD);break;case"set_colors_ack":if(aB){am=aD}break;case"get_data_ack":if(aB){get_data_ack(aD)}break;case"get_webgl_ack":if(aB){g(aD.vertex_shader,aD.fragment_shader)}break;default:}}function I(aA){af&&console.log("WEBSOCKET: ONCLOSE");ab()}function aa(aA){af&&console.log("WEBSOCKET: ONERROR")}function a(aA,aC,aB){af&&console.log("WEBSOCKET: SENT MESSAGE TO SERVER: "+O(aC,aB));if(r.readyState===r.OPEN){servers.data[aA].socket.send(O(aC,aB))}}function O(aC,aB){var aA={method:aC,params:aB};return JSON.stringify(aA)}function A(){try{ay=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var aA=new RTCPeerConnection({iceServers:[]});aA.createDataChannel("");aA.createOffer(aA.setLocalDescription.bind(aA),ai);aA.onicecandidate=ao}catch(aB){console.log(aB.message)}}function ao(aA){if(!aA||!aA.candidate||!aA.candidate.candidate){return}var aB=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(aA.candidate.candidate)[1];this.onicecandidate=ai;ip=aB.split(".")[0]+"."+aB.split(".")[1]+"."+aB.split(".")[2];setTimeout(Q,5000);scan_counter=0;setTimeout(P,20)}function P(){scan_counter++;if(scan_counter<255){var aA=ip+"."+scan_counter;aq(aA);setTimeout(P,20)}}function ai(){}function Q(){af&&console.log("DISCOVER TIMEOUT");ay=false;if(!w){}}function V(){for(var aA=0;aA<y.length;++aA){y.shift().abort()}}function aq(aA){ah(aA).then(function(aB){S(aB);V()},function(aB){})}function ah(aA){return new Promise(function(aC,aB){try{var aE=new XMLHttpRequest();y.push(aE);aE.ip=aA;aE.timeout=1000;aE.open("GET","http://"+aA+":"+C,true);aE.ontimeout=function(aF){aB(Error("NA"))};aE.onerror=function(){aB(Error("NA"))};aE.onload=function(aG){if(aE.readyState===4){if(aE.status===200){console.log("FOUND SERVER: "+this.ip);w=true;var aF={};aF.ws="ws://"+this.ip+":"+C;aF.ip=this.ip;aC(aF)}}};aE.send()}catch(aD){"XHR:"+console.log(aD.message)}})}function S(aB){try{var aA=new WebSocket(aB.ws);aA.onopen=u;aA.onclose=I;aA.onerror=aa;aA.onmessage=function(aD){f(aD)};servers.data[x]={};servers.data[x].socket=aA;servers.data[x].id=x+1;servers.data[x].values={};servers.data[x].values.address=aB.ip;if(x==0){servers.data[x].values.selected=true}x++}catch(aC){console.log("DISCOVERY ERROR");console.log(aC.message)}}function L(aB){for(var aA=0;aA<x;aA++){if(aB.ip===servers.data[aA].values.address){servers.data[aA].values.hostname=aB.hostname;servers.data[aA].values.platform=aB.platform;servers.data[aA].values.status=aB.status}}serverGrid.processJSON(servers);serverGrid.tableLoaded();aj.innerHTML="Configuring: "+servers.data[B].values.hostname}function ap(){if(am&&am.shader_params&&am.shader_params.width&&am.shader_params.height&&am.colors&&am.colors.data){al=am.shader_params.width;k=am.shader_params.height;if(am.colors&&al*k*3==am.colors.data.length){ae=am.colors.data}}else{al=8;k=8;ae=new Uint8Array(al*k*3).fill(32)}const aB=twgl.createTexture(Y,{width:al,height:k,internalFormat:Y.RGB,min:Y.NEAREST,mag:Y.NEAREST,src:ae});twgl.resizeCanvasToDisplaySize(Y.canvas,window.devicePixelRatio);Y.viewport(0,0,Y.canvas.width,Y.canvas.height);const aA={time:Math.random()/5,canvas_resolution:[Y.canvas.width,Y.canvas.height],texture_resolution:[al,k],tex:aB};if(k*al*3!=ae.length){return}twgl.setUniforms(e,aA);twgl.drawBufferInfo(Y,X);Y.deleteTexture(aB);requestAnimationFrame(ap)}function av(){am=null}function Z(aA){}function j(){af&&console.log("UI INIT");ar()}function ar(){az.style.color="red";if(!ag){D()}}function v(){af&&console.log("UI CONNECTED");ag=true;az.style.color="green";a(B,"get_data_req",null)}function ab(){af&&console.log("UI DISCONNECTED");at=false;J();ag=false;av();ar()}function g(aB,aA){q.text=aB;an.text=aA;K={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};Y=document.querySelector("#canvas").getContext("webgl");e=twgl.createProgramInfo(Y,["vs","fs"]);X=twgl.createBufferInfoFromArrays(Y,K);Y.useProgram(e.program);twgl.setBuffersAndAttributes(Y,e,X);requestAnimationFrame(ap)}function J(){if(!ag){return}at=!at;if(at){H.style.display="none";ax.style.opacity=1;az.innerHTML="<B>Show</B>";ad.style.display="none";ac.style.display="none";n.style.display="none";o.style.display="none"}else{H.style.display="inline-block";ax.style.opacity=0.5;az.innerHTML="<B>Hide</B>";ad.style.display="block";ac.style.display="block";n.style.display="block";o.style.display="block"}}function R(){init_grids();az.style.display="block";az.onclick=J;ad.onclick=au;ac.onclick=E;n.onclick=d;o.onclick=T;au()}function au(){ad.style.color="white";server_grid.style.display="block";ac.style.color="gray";layer_grid.style.display="none";n.style.color="gray";shader_grid.style.display="none";o.style.color="gray";device_grid.style.display="none"}function E(){ad.style.color="gray";server_grid.style.display="none";ac.style.color="white";layer_grid.style.display="block";n.style.color="gray";shader_grid.style.display="none";o.style.color="gray";device_grid.style.display="none"}function d(){ad.style.color="gray";server_grid.style.display="none";n.style.color="white";shader_grid.style.display="block";ac.style.color="gray";layer_grid.style.display="none";o.style.color="gray";device_grid.style.display="none"}function T(){ad.style.color="gray";server_grid.style.display="none";ac.style.color="gray";layer_grid.style.display="none";n.style.color="gray";shader_grid.style.display="none";o.style.color="white";device_grid.style.display="block"}R();j()};