function rgb_led_matrix_init(){var S=false,ah=1,L=false,ac=1,W=null,ap=true,E=document.getElementById("server_name"),p=document.getElementById("canvas"),U=document.getElementById("ui"),am=document.getElementById("menu"),c=document.getElementById("show_button"),ad=document.getElementById("server_button"),v=document.getElementById("layer_button"),C=document.getElementById("shader_button"),P=document.getElementById("device_button"),o=document.getElementById("connect_button"),N=document.getElementById("fs"),z=document.getElementById("vs"),B=true,aq=null,w=null,u=null,F=null,m=null,a=8,f=1,ab=0,s=0,K=0,ao=0,Z=0,h=0,g=0,al=null,q=null,e=null,T=[],Y=8080,H=8443,d=[],b=[],V=0;function af(){S&&console.log("WEBSOCKET: OPEN");y();this.send(json("get_webgl_req"));this.send(json("get_info_req"))}function R(au){S&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+au.data.toString());var at=servers.data[selected_server].values.address==new URL(au.origin).hostname;var ar=JSON.parse(au.data.toString());var aw=ar.method;var av=ar.params;switch(aw){case"discover_server_ack":O(av);break;case"get_info_ack":x(av);break;case"set_colors_ack":if(at){aq=av}break;case"get_data_ack":if(at){get_data_ack(av)}break;case"get_webgl_ack":if(at){aa(av.vertex_shader,av.fragment_shader)}break;default:}}function I(ar){S&&console.log("WEBSOCKET: ONCLOSE");data_close(new URL(this.url).hostname);Q()}function n(ar){S&&console.log("WEBSOCKET: ONERROR ")}function j(){try{discovering=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var ar=new RTCPeerConnection({iceServers:[]});ar.createDataChannel("");ar.createOffer(ar.setLocalDescription.bind(ar),ai);ar.onicecandidate=X}catch(at){console.log(at.message)}}function ai(){}function X(ar){if(!ar||!ar.candidate||!ar.candidate.candidate){return}var at=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ar.candidate.candidate)[1];this.onicecandidate=ai;ip=at.split(".")[0]+"."+at.split(".")[1]+"."+at.split(".")[2];scan_counter=0;setTimeout(an,20)}function an(){scan_counter++;if(scan_counter<255){var ar=ip+"."+scan_counter;t(ar);setTimeout(an,20)}}function G(){for(var ar=0;ar<T.length;++ar){T.shift().abort()}}function t(ar){ag(ar).then(function(at){r(at);G()},function(at){})}function ag(ar){return new Promise(function(au,at){try{var aw=new XMLHttpRequest();T.push(aw);aw.ip=ar;aw.timeout=1000;aw.open("GET","http://"+ar+":"+Y,true);aw.ontimeout=function(ax){at(Error("NA"))};aw.onerror=function(){at(Error("NA"))};aw.onload=function(ay){if(aw.readyState===4){if(aw.status===200){console.log("FOUND SERVER: "+this.ip);var ax={};ax.ws="ws://"+this.ip+":"+Y;ax.ip=this.ip;au(ax)}}};aw.send()}catch(av){"XHR:"+console.log(av.message)}})}function r(au){try{var ar=new WebSocket(au.ws);ar.onopen=af;ar.onclose=I;ar.onerror=n;ar.onmessage=R;var av=false;if(V>0){for(var at=0;at<V;at++){if(au.ip===servers.data[at].values.address){console.log("FOUND "+au.ip);servers.data[at].socket=ar;if(selected_server==-1){selected_server=at}av=true}}}if(selected_server==-1){selected_server=0}if(!av){servers.data[V]={};servers.data[V].socket=ar;servers.data[V].id=V+1;servers.data[V].values={};servers.data[V].values.address=au.ip;if(V==0){servers.data[V].values.selected=true}V++}else{servers.data[selected_server].values.selected=true;Q();serverGrid.processJSON(servers);serverGrid.tableLoaded()}}catch(aw){console.log("DISCOVERY ERROR");console.log(aw.message)}}function x(at){for(var ar=0;ar<V;ar++){if(at.ip===servers.data[ar].values.address){servers.data[ar].values.hostname=at.hostname;servers.data[ar].values.platform=at.platform;servers.data[ar].values.status=at.status}}Q();serverGrid.processJSON(servers);serverGrid.tableLoaded()}function O(at){var ar={};ar.ws="ws://"+at.ip+":"+Y;ar.ip=at.ip;r(ar)}function y(){socket_send(selected_server,"get_data_req",null);L=true}function D(){if(!L){j()}console.log(L)}setInterval(D,5000);function A(){if(aq&&aq.width&&aq.height&&aq.colors&&aq.colors.data){W=aq.colors.data;const at=twgl.createTexture(w,{width:aq.width,height:aq.height,internalFormat:w.RGB,min:w.NEAREST,mag:w.NEAREST,src:W});twgl.resizeCanvasToDisplaySize(w.canvas,window.devicePixelRatio);w.viewport(0,0,w.canvas.width,w.canvas.height);const ar={time:Math.random()/5,canvas_resolution:[w.canvas.width,w.canvas.height],texture_resolution:[aq.width,aq.height],tex:at};twgl.setUniforms(u,ar);twgl.drawBufferInfo(w,m);w.deleteTexture(at)}requestAnimationFrame(A)}function M(){S&&console.log("UI INIT");D()}function D(){c.style.color="red";if(!L){j()}}function y(){S&&console.log("UI CONNECTED");L=true;c.style.color="green";socket_send(selected_server,"get_data_req",null)}function aa(at,ar){z.text=at;N.text=ar;F={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};w=document.querySelector("#canvas").getContext("webgl");u=twgl.createProgramInfo(w,["vs","fs"]);m=twgl.createBufferInfoFromArrays(w,F);w.useProgram(u.program);twgl.setBuffersAndAttributes(w,u,m);requestAnimationFrame(A)}function ak(){B=!B;if(B){U.style.display="none";p.style.opacity=1;c.innerHTML="<B>Show</B>";ad.style.display="none";v.style.display="none";C.style.display="none";P.style.display="none";server_config.style.display="none"}else{U.style.display="inline-block";p.style.opacity=0.5;c.innerHTML="<B>Hide</B>";ad.style.display="block";v.style.display="block";C.style.display="block";P.style.display="block";server_config.style.display="flex"}}function ae(){var ar=document.createElement("option");ar.text="None";server_menu.add(ar);init_grids();c.style.display="block";c.onclick=ak;ad.onclick=i;v.onclick=J;C.onclick=aj;P.onclick=k;server_menu.onchange=l;B=true;ak();i()}function i(){ad.style.color="white";server_grid.style.display="block";v.style.color="gray";layer_grid.style.display="none";C.style.color="gray";shader_grid.style.display="none";P.style.color="gray";device_grid.style.display="none"}function J(){ad.style.color="gray";server_grid.style.display="none";v.style.color="white";layer_grid.style.display="block";C.style.color="gray";shader_grid.style.display="none";P.style.color="gray";device_grid.style.display="none"}function aj(){ad.style.color="gray";server_grid.style.display="none";C.style.color="white";shader_grid.style.display="block";v.style.color="gray";layer_grid.style.display="none";P.style.color="gray";device_grid.style.display="none"}function k(){ad.style.color="gray";server_grid.style.display="none";v.style.color="gray";layer_grid.style.display="none";C.style.color="gray";shader_grid.style.display="none";P.style.color="white";device_grid.style.display="block"}function l(){serverChanged(server_menu.selectedIndex,0,false,true,null)}function Q(){server_menu.innerText=null;if(!L){var at=document.createElement("option");at.text="None";server_menu.add(at)}else{for(var ar=0;ar<V;ar++){var at=document.createElement("option");at.text=servers.data[ar].values.hostname;server_menu.add(at)}server_menu.selectedIndex=selected_server}}ae();M()};