function rgb_led_matrix_init(){var T=false,aj=1,M=false,ae=1,Y=null,ar=true,F=document.getElementById("server_name"),p=document.getElementById("canvas"),V=document.getElementById("ui"),ao=document.getElementById("menu"),c=document.getElementById("show_button"),af=document.getElementById("server_button"),w=document.getElementById("layer_button"),D=document.getElementById("shader_button"),Q=document.getElementById("device_button"),o=document.getElementById("connect_button"),O=document.getElementById("fs"),A=document.getElementById("vs"),C=true,at=null,x=null,v=null,G=null,m=null,a=8,f=1,ad=0,s=0,L=0,aq=0,ab=0,h=0,g=0,an=null,q=null,e=null,U=[],aa=8080,I=8443,d=[],b=[],W=0;function ah(){T&&console.log("WEBSOCKET: OPEN");z();this.send(json("get_webgl_req"));this.send(json("get_info_req"))}function S(aw){T&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+aw.data.toString());var av=servers.data[selected_server].values.address==new URL(aw.origin).hostname;var au=JSON.parse(aw.data.toString());var ay=au.method;var ax=au.params;switch(ay){case"discover_server_ack":P(ax);break;case"get_info_ack":y(ax);break;case"set_colors_ack":if(av){at=ax}break;case"get_data_ack":if(av){get_data_ack(ax)}break;case"get_webgl_ack":if(av){ac(ax.vertex_shader,ax.fragment_shader)}break;default:}}function J(au){T&&console.log("WEBSOCKET: ONCLOSE");t(new URL(this.url).hostname);R()}function n(au){T&&console.log("WEBSOCKET: ONERROR ")}function j(){try{discovering=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var au=new RTCPeerConnection({iceServers:[]});au.createDataChannel("");au.createOffer(au.setLocalDescription.bind(au),ak);au.onicecandidate=Z}catch(av){console.log(av.message)}}function ak(){}function Z(au){if(!au||!au.candidate||!au.candidate.candidate){return}var av=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(au.candidate.candidate)[1];this.onicecandidate=ak;ip=av.split(".")[0]+"."+av.split(".")[1]+"."+av.split(".")[2];scan_counter=0;setTimeout(ap,20)}function ap(){scan_counter++;if(scan_counter<255){var au=ip+"."+scan_counter;u(au);setTimeout(ap,20)}}function H(){for(var au=0;au<U.length;++au){U.shift().abort()}}function u(au){ai(au).then(function(av){r(av);H()},function(av){})}function ai(au){return new Promise(function(aw,av){try{var ay=new XMLHttpRequest();U.push(ay);ay.ip=au;ay.timeout=1000;ay.open("GET","http://"+au+":"+aa,true);ay.ontimeout=function(az){av(Error("NA"))};ay.onerror=function(){av(Error("NA"))};ay.onload=function(aA){if(ay.readyState===4){if(ay.status===200){console.log("FOUND SERVER: "+this.ip);var az={};az.ws="ws://"+this.ip+":"+aa;az.ip=this.ip;aw(az)}}};ay.send()}catch(ax){"XHR:"+console.log(ax.message)}})}function r(aw){try{var au=new WebSocket(aw.ws);au.onopen=ah;au.onclose=J;au.onerror=n;au.onmessage=S;var ax=false;if(W>0){for(var av=0;av<W;av++){if(aw.ip===servers.data[av].values.address){console.log("FOUND "+aw.ip);servers.data[av].socket=au;if(selected_server==-1){selected_server=av}ax=true}}}if(selected_server==-1){selected_server=0}if(!ax){servers.data[W]={};servers.data[W].socket=au;servers.data[W].id=W+1;servers.data[W].values={};servers.data[W].values.address=aw.ip;if(W==0){servers.data[W].values.selected=true}W++}else{servers.data[selected_server].values.selected=true;R();serverGrid.processJSON(servers);serverGrid.tableLoaded()}}catch(ay){console.log("DISCOVERY ERROR");console.log(ay.message)}}function y(av){for(var au=0;au<W;au++){if(av.ip===servers.data[au].values.address){servers.data[au].values.hostname=av.hostname;servers.data[au].values.platform=av.platform;servers.data[au].values.status=av.status}}R();serverGrid.processJSON(servers);serverGrid.tableLoaded()}function P(av){var au={};au.ws="ws://"+av.ip+":"+aa;au.ip=av.ip;r(au)}function t(av){for(var au=0;au<servers.data.length;au++){if(servers.data[au].values.address==av){servers.data[au].values.status="DOWN";if(servers.data[au].values.selected){servers.data[au].values.selected=false;selected_server=findFirstUp()}if(selected_server>=0){servers.data[selected_server].values.selected=true;socket_send(selected_server,"get_data_req",null)}server_menu.selectedIndex=selected_server;serverGrid.processJSON(servers);serverGrid.tableLoaded();return selected_server}}}function X(aw,az,au,ax,ay){if(ax==false){servers.data[aw].values.selected=true}else{if(servers.data[aw].values.status=="DOWN"){servers.data[aw].values.selected=false}else{for(var av=0;av<servers.data.length;av++){servers.data[av].values.selected=false}servers.data[aw].values.selected=true;selected_server=aw;socket_send(selected_server,"get_data_req",null)}}server_menu.selectedIndex=selected_server;serverGrid.processJSON(servers);serverGrid.tableLoaded()}function z(){socket_send(selected_server,"get_data_req",null);M=true}function E(){if(!M){j()}console.log(M)}setInterval(E,5000);function B(){if(at&&at.width&&at.height&&at.colors&&at.colors.data){Y=at.colors.data;const av=twgl.createTexture(x,{width:at.width,height:at.height,internalFormat:x.RGB,min:x.NEAREST,mag:x.NEAREST,src:Y});twgl.resizeCanvasToDisplaySize(x.canvas,window.devicePixelRatio);x.viewport(0,0,x.canvas.width,x.canvas.height);const au={time:Math.random()/5,canvas_resolution:[x.canvas.width,x.canvas.height],texture_resolution:[at.width,at.height],tex:av};twgl.setUniforms(v,au);twgl.drawBufferInfo(x,m);x.deleteTexture(av)}requestAnimationFrame(B)}function N(){T&&console.log("UI INIT");E()}function E(){c.style.color="red";if(!M){j()}}function z(){T&&console.log("UI CONNECTED");M=true;c.style.color="green";socket_send(selected_server,"get_data_req",null)}function ac(av,au){A.text=av;O.text=au;G={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};x=document.querySelector("#canvas").getContext("webgl");v=twgl.createProgramInfo(x,["vs","fs"]);m=twgl.createBufferInfoFromArrays(x,G);x.useProgram(v.program);twgl.setBuffersAndAttributes(x,v,m);requestAnimationFrame(B)}function am(){C=!C;if(C){V.style.display="none";p.style.opacity=1;c.innerHTML="<B>Show</B>";af.style.display="none";w.style.display="none";D.style.display="none";Q.style.display="none";server_config.style.display="none"}else{V.style.display="inline-block";p.style.opacity=0.5;c.innerHTML="<B>Hide</B>";af.style.display="block";w.style.display="block";D.style.display="block";Q.style.display="block";server_config.style.display="flex"}}function ag(){var au=document.createElement("option");au.text="None";server_menu.add(au);init_grids();c.style.display="block";c.onclick=am;af.onclick=i;w.onclick=K;D.onclick=al;Q.onclick=k;server_menu.onchange=l;C=true;am();i()}function i(){af.style.color="white";server_grid.style.display="block";w.style.color="gray";layer_grid.style.display="none";D.style.color="gray";shader_grid.style.display="none";Q.style.color="gray";device_grid.style.display="none"}function K(){af.style.color="gray";server_grid.style.display="none";w.style.color="white";layer_grid.style.display="block";D.style.color="gray";shader_grid.style.display="none";Q.style.color="gray";device_grid.style.display="none"}function al(){af.style.color="gray";server_grid.style.display="none";D.style.color="white";shader_grid.style.display="block";w.style.color="gray";layer_grid.style.display="none";Q.style.color="gray";device_grid.style.display="none"}function k(){af.style.color="gray";server_grid.style.display="none";w.style.color="gray";layer_grid.style.display="none";D.style.color="gray";shader_grid.style.display="none";Q.style.color="white";device_grid.style.display="block"}function l(){X(server_menu.selectedIndex,0,false,true,null)}function R(){server_menu.innerText=null;if(!M){var av=document.createElement("option");av.text="None";server_menu.add(av)}else{for(var au=0;au<W;au++){var av=document.createElement("option");av.text=servers.data[au].values.hostname;server_menu.add(av)}server_menu.selectedIndex=selected_server}}ag();N()};