function rgb_led_matrix_init(){var ar=false,n=1,at=false,af=1,aq=null,c=true,aw=document.getElementById("server_name"),aI=document.getElementById("canvas"),N=document.getElementById("ui"),m=document.getElementById("menu"),aJ=document.getElementById("show_button"),ap=document.getElementById("server_button"),an=document.getElementById("layer_button"),o=document.getElementById("shader_button"),p=document.getElementById("device_button"),d=document.getElementById("connect_button"),az=document.getElementById("fs"),t=document.getElementById("vs"),aE=true,a=null,al=null,f=null,R=null,ak=null,ay=8,l=1,L=0,M=0,i=0,v=0,w=0,aj=0,W=0,j=null,aH=null,ax=null,B=[],H=8080,s=8443,D=[],u=[],A=0;function y(){ar&&console.log("WEBSOCKET: OPEN");z();this.send(X("get_webgl_req"));this.send(X("get_info_req"))}function g(aM){ar&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+aM.data.toString());var aL=Z.data[G].values.address==new URL(aM.origin).hostname;var aK=JSON.parse(aM.data.toString());var aO=aK.method;var aN=aK.params;switch(aO){case"discover_server_ack":U(aN);break;case"get_info_ack":T(aN);break;case"set_colors_ack":if(aL){a=aN}break;case"get_data_ack":if(aL){I(aN)}break;case"get_webgl_ack":if(aL){h(aN.vertex_shader,aN.fragment_shader)}break;default:}}function O(aK){ar&&console.log("WEBSOCKET: ONCLOSE");S(new URL(this.url).hostname);ae()}function am(aK){ar&&console.log("WEBSOCKET: ONERROR ")}function F(){try{discovering=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var aK=new RTCPeerConnection({iceServers:[]});aK.createDataChannel("");aK.createOffer(aK.setLocalDescription.bind(aK),av);aK.onicecandidate=aA}catch(aL){console.log(aL.message)}}function av(){}function aA(aK){if(!aK||!aK.candidate||!aK.candidate.candidate){return}var aL=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(aK.candidate.candidate)[1];this.onicecandidate=av;ip=aL.split(".")[0]+"."+aL.split(".")[1]+"."+aL.split(".")[2];scan_counter=0;setTimeout(Y,20)}function Y(){scan_counter++;if(scan_counter<255){var aK=ip+"."+scan_counter;aC(aK);setTimeout(Y,20)}}function ai(){for(var aK=0;aK<B.length;++aK){B.shift().abort()}}function aC(aK){au(aK).then(function(aL){ac(aL);ai()},function(aL){})}function au(aK){return new Promise(function(aM,aL){try{var aO=new XMLHttpRequest();B.push(aO);aO.ip=aK;aO.timeout=1000;aO.open("GET","http://"+aK+":"+H,true);aO.ontimeout=function(aP){aL(Error("NA"))};aO.onerror=function(){aL(Error("NA"))};aO.onload=function(aQ){if(aO.readyState===4){if(aO.status===200){console.log("FOUND SERVER: "+this.ip);var aP={};aP.ws="ws://"+this.ip+":"+H;aP.ip=this.ip;aM(aP)}}};aO.send()}catch(aN){"XHR:"+console.log(aN.message)}})}function ac(aM){try{var aK=new WebSocket(aM.ws);aK.onopen=y;aK.onclose=O;aK.onerror=am;aK.onmessage=g;var aN=false;if(A>0){for(var aL=0;aL<A;aL++){if(aM.ip===Z.data[aL].values.address){console.log("FOUND "+aM.ip);Z.data[aL].socket=aK;if(G==-1){G=aL}aN=true}}}if(G==-1){G=0}if(!aN){Z.data[A]={};Z.data[A].socket=aK;Z.data[A].id=A+1;Z.data[A].values={};Z.data[A].values.address=aM.ip;if(A==0){Z.data[A].values.selected=true}A++}else{Z.data[G].values.selected=true;ae();q.processJSON(Z);q.tableLoaded()}}catch(aO){console.log("DISCOVERY ERROR");console.log(aO.message)}}function T(aL){for(var aK=0;aK<A;aK++){if(aL.ip===Z.data[aK].values.address){Z.data[aK].values.hostname=aL.hostname;Z.data[aK].values.platform=aL.platform;Z.data[aK].values.status=aL.status}}ae();q.processJSON(Z);q.tableLoaded()}function U(aL){var aK={};aK.ws="ws://"+aL.ip+":"+H;aK.ip=aL.ip;ac(aK)}function z(){b(G,"get_data_req",null);at=true}function aD(){if(!at){F()}console.log(at)}setInterval(aD,5000);function aB(){if(a&&a.width&&a.height&&a.colors&&a.colors.data){aq=a.colors.data;const aL=twgl.createTexture(al,{width:a.width,height:a.height,internalFormat:al.RGB,min:al.NEAREST,mag:al.NEAREST,src:aq});twgl.resizeCanvasToDisplaySize(al.canvas,window.devicePixelRatio);al.viewport(0,0,al.canvas.width,al.canvas.height);const aK={time:Math.random()/5,canvas_resolution:[al.canvas.width,al.canvas.height],texture_resolution:[a.width,a.height],tex:aL};twgl.setUniforms(f,aK);twgl.drawBufferInfo(al,ak);al.deleteTexture(aL)}requestAnimationFrame(aB)}function k(){ar&&console.log("UI INIT");aD()}function aD(){aJ.style.color="red";if(!at){F()}}function z(){ar&&console.log("UI CONNECTED");at=true;aJ.style.color="green";b(G,"get_data_req",null)}function h(aL,aK){t.text=aL;az.text=aK;R={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};al=document.querySelector("#canvas").getContext("webgl");f=twgl.createProgramInfo(al,["vs","fs"]);ak=twgl.createBufferInfoFromArrays(al,R);al.useProgram(f.program);twgl.setBuffersAndAttributes(al,f,ak);requestAnimationFrame(aB)}function P(){aE=!aE;if(aE){N.style.display="none";aI.style.opacity=1;aJ.innerHTML="<B>Show</B>";ap.style.display="none";an.style.display="none";o.style.display="none";p.style.display="none";server_config.style.display="none"}else{N.style.display="inline-block";aI.style.opacity=0.5;aJ.innerHTML="<B>Hide</B>";ap.style.display="block";an.style.display="block";o.style.display="block";p.style.display="block";server_config.style.display="flex"}}function ab(){var aK=document.createElement("option");aK.text="None";server_menu.add(aK);aa();aJ.style.display="block";aJ.onclick=P;ap.onclick=aF;an.onclick=K;o.onclick=e;p.onclick=ag;server_menu.onchange=E;aE=true;P();aF()}function aF(){ap.style.color="white";server_grid.style.display="block";an.style.color="gray";layer_grid.style.display="none";o.style.color="gray";shader_grid.style.display="none";p.style.color="gray";device_grid.style.display="none"}function K(){ap.style.color="gray";server_grid.style.display="none";an.style.color="white";layer_grid.style.display="block";o.style.color="gray";shader_grid.style.display="none";p.style.color="gray";device_grid.style.display="none"}function e(){ap.style.color="gray";server_grid.style.display="none";o.style.color="white";shader_grid.style.display="block";an.style.color="gray";layer_grid.style.display="none";p.style.color="gray";device_grid.style.display="none"}function ag(){ap.style.color="gray";server_grid.style.display="none";an.style.color="gray";layer_grid.style.display="none";o.style.color="gray";shader_grid.style.display="none";p.style.color="white";device_grid.style.display="block"}function E(){J(server_menu.selectedIndex,0,false,true,null)}function ae(){server_menu.innerText=null;if(!at){var aL=document.createElement("option");aL.text="None";server_menu.add(aL)}else{for(var aK=0;aK<A;aK++){var aL=document.createElement("option");aL.text=Z.data[aK].values.hostname;server_menu.add(aL)}server_menu.selectedIndex=G}}var ar=false;var q={};var r={};var aG={};var ad={};var x={};var Z={};var G=0;function ao(aN){var aK=this.getRowValues(aN);aK.name=aK.name;var aM=0;for(var aL=0;aL<this.getRowCount();aL++){aM=Math.max(aM,parseInt(this.getRowId(aL))+1)}this.insertAfter(aN,aM,aK);C()}function aa(){var aK={enableSort:false};r=new EditableGrid("layerGrid",aK);r.modelChanged=C;r.tableLoaded=function(){r.duplicate=ao;r.setCellRenderer("action",new CellRenderer({render:function(aL,aM){aL.innerHTML=ah(r,aL.rowIndex)}}));r.renderGrid("layer_grid","grid")};aG=new EditableGrid("shaderGrid",aK);aG.modelChanged=C;aG.tableLoaded=function(){aG.renderGrid("shader_grid","grid")};ad=new EditableGrid("deviceGrid",aK);ad.modelChanged=C;ad.tableLoaded=function(){ad.renderGrid("device_grid","grid")};q=new EditableGrid("serverGrid",aK);q.modelChanged=J;q.tableLoaded=function(){q.setCellRenderer("action",new CellRenderer({render:function(aL,aM){aL.innerHTML=V(q,aL.rowIndex,aL);Z.data[aL.rowIndex].cell=aL}}));q.renderGrid("server_grid","grid")};Z={};Z.metadata=[];Z.metadata[0]={};Z.metadata[0].name="selected";Z.metadata[0].label="Selected";Z.metadata[0].datatype="boolean";Z.metadata[0].editable=true;Z.metadata[1]={};Z.metadata[1].name="hostname";Z.metadata[1].label="Hostname";Z.metadata[1].datatype="string";Z.metadata[1].editable=false;Z.metadata[2]={};Z.metadata[2].name="platform";Z.metadata[2].label="Platform";Z.metadata[2].datatype="string";Z.metadata[2].editable=false;Z.metadata[3]={};Z.metadata[3].name="address";Z.metadata[3].label="Address";Z.metadata[3].datatype="string";Z.metadata[3].editable=false;Z.metadata[4]={};Z.metadata[4].name="action";Z.metadata[4].label="Status";Z.metadata[4].datatype="html";Z.metadata[4].editable=false;Z.data=[];q.processJSON(Z);q.tableLoaded()}function I(aK){r.processJSON(aK.layers);r.tableLoaded();aG.processJSON(aK.shaders);aG.tableLoaded();ad.processJSON(aK.devices);ad.tableLoaded()}function C(){x={};x.layers={};x.layers.data=[];for(var aK=0;aK<r.data.length;aK++){x.layers.data[aK]={};x.layers.data[aK].id=r.data[aK].id;x.layers.data[aK].values={};x.layers.data[aK].values.layer=r.data[aK].columns[0];x.layers.data[aK].values.device=r.data[aK].columns[1];x.layers.data[aK].values.geometry=r.data[aK].columns[2];x.layers.data[aK].values.shader=r.data[aK].columns[3];x.layers.data[aK].values.options=r.data[aK].columns[4]}x.shaders={};x.shaders.data=[];for(var aK=0;aK<aG.data.length;aK++){x.shaders.data[aK]={};x.shaders.data[aK].id=aG.data[aK].id;x.shaders.data[aK].values={};x.shaders.data[aK].values.options=aG.data[aK].columns[0]}x.devices={};x.devices.data=[];for(var aK=0;aK<ad.data.length;aK++){x.devices.data[aK]={};x.devices.data[aK].id=ad.data[aK].id;x.devices.data[aK].values={};x.devices.data[aK].values.options=ad.data[aK].columns[0]}b(G,"set_data_req",x)}function b(aK,aM,aL){ar&&console.log("WEBSOCKET: SENT MESSAGE TO SERVER: "+X(aM,aL));if(Z.data[aK].socket.readyState===Z.data[aK].socket.OPEN){Z.data[aK].socket.send(X(aM,aL))}}function X(aM,aL){var aK={method:aM,params:aL};return JSON.stringify(aK)}function Q(){for(var aK=0;aK<Z.data.length;aK++){if(Z.data[aK].values.status=="UP"){return aK}}at=false;return -1}function S(aL){for(var aK=0;aK<Z.data.length;aK++){if(Z.data[aK].values.address==aL){Z.data[aK].values.status="DOWN";if(Z.data[aK].values.selected){Z.data[aK].values.selected=false;G=Q()}if(G>=0){Z.data[G].values.selected=true;b(G,"get_data_req",null)}server_menu.selectedIndex=G;q.processJSON(Z);q.tableLoaded();return G}}}function J(aM,aP,aK,aN,aO){if(aN==false){Z.data[aM].values.selected=true}else{if(Z.data[aM].values.status=="DOWN"){Z.data[aM].values.selected=false}else{for(var aL=0;aL<Z.data.length;aL++){Z.data[aL].values.selected=false}Z.data[aM].values.selected=true;G=aM;b(G,"get_data_req",null)}}server_menu.selectedIndex=G;q.processJSON(Z);q.tableLoaded()}function ah(aM,aL){var aK;aK='<a onclick="if ('+aM.name+".data.length>1) "+aM.name+".remove("+aL+'); set_data_req(); " style="cursor:pointer"><img src="img/delete.png" border="0" alt="delete" title="Delete row"/></a>';aK+='&nbsp;<a onclick="'+aM.name+".duplicate("+aL+');  set_data_req();" style="cursor:pointer"><img src="img/duplicate.png" border="0" alt="duplicate" title="Duplicate row"/></a>';return aK}function V(aN,aM){var aL;var aK="closed";if(Z.data[aM].values.status=="UP"){aK="open"}aL='&nbsp;<a style="cursor:pointer"><img src="img/'+aK+'.png" border="0" alt="connect" title="Reconnect"/></a>';return aL}ab();k()};