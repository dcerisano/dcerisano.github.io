function rgb_led_matrix_init(){var L=false,u=null,F=null,h=null,ak={},l={},I="localhost:8080",aa=null,ac=1,r=false,B=false,X=1,R=null,n=document.getElementById("emulator"),O=document.getElementById("ui"),E=null,C=null,ai=n.getContext("2d"),a=8,d=1,W=0,p=0,A=0,ah=0,V=0,g=0,e=0,ae=null,o=null,c=null,x=false,aj=false,M=[],T=8080,K=null;function P(al,an,am){L&&console.log("WEBSOCKET: CONNECT");k()}function Z(){L&&console.log("WEBSOCKET: OPEN");socket=this;s()}function J(am){L&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+am.data.toString());var al=JSON.parse(am.data.toString());var ao=al.method;var an=al.params;switch(ao){case"set_colors_ack":t(an);ag(an);break;case"get_shaders_ack":u=an;break;case"get_controllers_ack":F=an;break;case"get_images_ack":h=an;break;default:}}function y(al){L&&console.log("WEBSOCKET: ONCLOSE");aa=null;N()}function m(al){L&&console.log("WEBSOCKET: ONERROR")}function H(am,al){L&&console.log("WEBSOCKET: SENT MESSAGE TO SERVER: "+U(am,al));if(socket.readyState===socket.OPEN){socket.send(U(am,al))}}function U(an,am){var al={method:an,params:am};return JSON.stringify(al)}function k(){try{x=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var al=new RTCPeerConnection({iceServers:[]});al.createDataChannel("");al.createOffer(al.setLocalDescription.bind(al),ad);al.onicecandidate=S}catch(am){console.log(am.message)}}function S(al){if(!al||!al.candidate||!al.candidate.candidate){return}var am=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(al.candidate.candidate)[1];this.onicecandidate=ad;K=am.split(".")[0]+"."+am.split(".")[1]+"."+am.split(".")[2];setTimeout(Q,5000);scan_counter=0;setTimeout(af,20)}function af(){scan_counter++;if(scan_counter<255){var al=K+"."+scan_counter;q(al);setTimeout(af,20)}}function ad(){}function Q(){L&&console.log("DISCOVER TIMEOUT");x=false;if(!aj){}}function w(){for(var al=0;al<M.length;++al){M.shift().abort()}}function q(al){ab(al).then(function(am){z(am);w()},function(am){})}function ab(al){return new Promise(function(an,am){try{var ap=new XMLHttpRequest();M.push(ap);ap.ip=al;ap.timeout=1000;ap.open("GET","http://"+al+":"+T,true);ap.ontimeout=function(aq){am(Error("NA"))};ap.onerror=function(){am(Error("NA"))};ap.onload=function(aq){if(ap.readyState===4){if(ap.status===200){console.log("FOUND SERVER: "+this.ip);aj=true;an("ws://"+this.ip+":"+T)}}};ap.send()}catch(ao){console.log(ao.message)}})}function z(al){try{socket=new WebSocket(al);socket.onopen=Z;socket.onclose=y;socket.onerror=m;socket.onmessage=function(an){J(an)}}catch(am){SIGNAL_DEBUG&&console.log("DISCOVERY ERROR");SIGNAL_DEBUG&&console.log(am.message)}}function ag(al){}G();function G(){L&&console.log("UI INIT");v()}function v(){if(!B){P("ws://"+I,s,N)}}function s(){L&&console.log("UI CONNECTED");B=true}function N(){L&&console.log("UI DISCONNECTED");B=false;t(null);v()}function Y(){document.getElementsByTagName("BODY")[0].onresize=t;E=new EditableGrid("Layers");E.tableLoaded=function(){this.renderGrid("layers","layer_grid")};E.loadJSON("data/layers.json");C=new EditableGrid("Properties");C.tableLoaded=function(){this.renderGrid("properties","property_grid")};C.loadJSON("data/properties.json")}Y();function t(am){if(am&&am.shader_params&&am.shader_params.width&&am.shader_params.height&&am.colors&&am.colors.data){a=am.shader_params.width;d=am.shader_params.height;if(am.colors){R=am.colors.data}}else{a=8;d=1;R=new Uint8Array(24).fill(0)}b(am);L&&console.log("drawMatrix");if(d*a*3!=R.length){return}for(i=0;i<a;i++){for(j=0;j<d;j++){var al=A*(i+1),an=ah*(j+1);f(al,an,V,D(i,j))}}}function b(){L&&console.log("resizeMatrix");W=window.innerWidth;p=window.innerHeight;g=0;e=0;n.width=W;n.height=p;n.style.width=W;n.style.height=p;A=W/(a+1);ah=p/(d+1);if(A>ah){A=ah}else{ah=A}e=(p-ah*(d+1))/2;g=(W-A*(a+1))/2;V=A*0.4}function D(am,ap){var ao=R[(ap*a+am)*3+0],an=R[(ap*a+am)*3+1],al=R[(ap*a+am)*3+2];if(typeof ao!=="undefined"&&an!=="undefined"&&al!=="undefined"){return"rgba("+ao+","+an+","+al+",1)"}else{return null}}function f(am,ao,al,an){if(an){ai.beginPath();ai.arc(am+g,ao+e,al,0,2*Math.PI,false);ai.fillStyle=an;ai.fill();ai.lineWidth=1;ai.strokeStyle="#101010";ai.stroke()}}};