function rgb_led_matrix_init(){var T=false,ai=1,M=false,ad=1,X=null,ar=true,E=document.getElementById("server_name"),p=document.getElementById("canvas"),V=document.getElementById("ui"),an=document.getElementById("menu"),c=document.getElementById("show_button"),ae=document.getElementById("server_button"),v=document.getElementById("layer_button"),C=document.getElementById("shader_button"),Q=document.getElementById("device_button"),o=document.getElementById("connect_button"),O=document.getElementById("fs"),z=document.getElementById("vs"),B=true,at=null,w=null,u=null,F=null,m=null,a=8,f=1,ac=0,s=0,L=0,ap=0,aa=0,h=0,g=0,am=null,q=null,e=null,I=false,aq=false,U=[],Z=8080,H=8443,d=[],b=[],W=0;function ag(){T&&console.log("WEBSOCKET: OPEN");y();this.send(json("get_webgl_req"));this.send(json("get_info_req"))}function S(aw){T&&console.log("WEBSOCKET: GOT MESSAGE FROM SERVER: "+aw.data.toString());var av=servers.data[selected_server].values.address==new URL(aw.origin).hostname;var au=JSON.parse(aw.data.toString());var ay=au.method;var ax=au.params;switch(ay){case"discover_server_ack":P(ax);break;case"get_info_ack":x(ax);break;case"set_colors_ack":if(av){at=ax}break;case"get_data_ack":if(av){get_data_ack(ax)}break;case"get_webgl_ack":if(av){ab(ax.vertex_shader,ax.fragment_shader)}break;default:}}function J(au){T&&console.log("WEBSOCKET: ONCLOSE");data_close(new URL(this.url).hostname);R()}function n(au){T&&console.log("WEBSOCKET: ONERROR ")}function j(){try{I=true;window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var au=new RTCPeerConnection({iceServers:[]});au.createDataChannel("");au.createOffer(au.setLocalDescription.bind(au),aj);au.onicecandidate=Y}catch(av){console.log(av.message)}}function aj(){}function Y(au){if(!au||!au.candidate||!au.candidate.candidate){return}var av=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(au.candidate.candidate)[1];this.onicecandidate=aj;ip=av.split(".")[0]+"."+av.split(".")[1]+"."+av.split(".")[2];scan_counter=0;setTimeout(ao,20)}function ao(){scan_counter++;if(scan_counter<255){var au=ip+"."+scan_counter;t(au);setTimeout(ao,20)}}function G(){for(var au=0;au<U.length;++au){U.shift().abort()}}function t(au){ah(au).then(function(av){r(av);G()},function(av){})}function ah(au){return new Promise(function(aw,av){try{var ay=new XMLHttpRequest();U.push(ay);ay.ip=au;ay.timeout=1000;ay.open("GET","http://"+au+":"+Z,true);ay.ontimeout=function(az){av(Error("NA"))};ay.onerror=function(){av(Error("NA"))};ay.onload=function(aA){if(ay.readyState===4){if(ay.status===200){console.log("FOUND SERVER: "+this.ip);aq=true;var az={};az.ws="ws://"+this.ip+":"+Z;az.ip=this.ip;aw(az)}}};ay.send()}catch(ax){"XHR:"+console.log(ax.message)}})}function r(aw){try{var au=new WebSocket(aw.ws);au.onopen=ag;au.onclose=J;au.onerror=n;au.onmessage=S;if(selected_server==-1){selected_server=0}var ax=false;if(W>0){for(var av=0;av<W;av++){if(aw.ip===servers.data[av].values.address){console.log("FOUND "+aw.ip);ax=true;servers.data[av].socket=au}}}if(!ax){servers.data[W]={};servers.data[W].socket=au;servers.data[W].id=W+1;servers.data[W].values={};servers.data[W].values.address=aw.ip;if(W==0){servers.data[W].values.selected=true}W++}}catch(ay){console.log("DISCOVERY ERROR");console.log(ay.message)}}function x(av){for(var au=0;au<W;au++){if(av.ip===servers.data[au].values.address){servers.data[au].values.hostname=av.hostname;servers.data[au].values.platform=av.platform;servers.data[au].values.status=av.status}}serverGrid.processJSON(servers);serverGrid.tableLoaded();R();server_menu.selectedIndex=selected_server}function P(av){var au={};au.ws="ws://"+av.ip+":"+Z;au.ip=av.ip;r(au)}function R(){server_menu.innerText=null;if(!M){var av=document.createElement("option");av.text="None";server_menu.add(av)}else{for(var au=0;au<W;au++){var av=document.createElement("option");av.text=servers.data[au].values.hostname;server_menu.add(av)}}server_menu.onchange=l}function l(){serverChanged(server_menu.selectedIndex,0,false,true,null)}function y(){socket_send(selected_server,"get_data_req",null);M=true}function D(){if(!M){j()}console.log(M)}setInterval(D,5000);function A(){if(at&&at.width&&at.height&&at.colors&&at.colors.data){X=at.colors.data;const av=twgl.createTexture(w,{width:at.width,height:at.height,internalFormat:w.RGB,min:w.NEAREST,mag:w.NEAREST,src:X});twgl.resizeCanvasToDisplaySize(w.canvas,window.devicePixelRatio);w.viewport(0,0,w.canvas.width,w.canvas.height);const au={time:Math.random()/5,canvas_resolution:[w.canvas.width,w.canvas.height],texture_resolution:[at.width,at.height],tex:av};twgl.setUniforms(u,au);twgl.drawBufferInfo(w,m);w.deleteTexture(av)}requestAnimationFrame(A)}function N(){T&&console.log("UI INIT");D()}function D(){c.style.color="red";if(!M){j()}}function y(){T&&console.log("UI CONNECTED");M=true;c.style.color="green";socket_send(selected_server,"get_data_req",null)}function ab(av,au){z.text=av;O.text=au;F={position:[-1,-1,0,1,-1,0,-1,1,0,-1,1,0,1,-1,0,1,1,0]};w=document.querySelector("#canvas").getContext("webgl");u=twgl.createProgramInfo(w,["vs","fs"]);m=twgl.createBufferInfoFromArrays(w,F);w.useProgram(u.program);twgl.setBuffersAndAttributes(w,u,m);requestAnimationFrame(A)}function al(){B=!B;if(B){V.style.display="none";p.style.opacity=1;c.innerHTML="<B>Show</B>";ae.style.display="none";v.style.display="none";C.style.display="none";Q.style.display="none";server_config.style.display="none"}else{V.style.display="inline-block";p.style.opacity=0.5;c.innerHTML="<B>Hide</B>";ae.style.display="block";v.style.display="block";C.style.display="block";Q.style.display="block";server_config.style.display="flex"}}function af(){var au=document.createElement("option");au.text="None";server_menu.add(au);init_grids();c.style.display="block";c.onclick=al;ae.onclick=i;v.onclick=K;C.onclick=ak;Q.onclick=k;B=true;al();i()}function i(){ae.style.color="white";server_grid.style.display="block";v.style.color="gray";layer_grid.style.display="none";C.style.color="gray";shader_grid.style.display="none";Q.style.color="gray";device_grid.style.display="none"}function K(){ae.style.color="gray";server_grid.style.display="none";v.style.color="white";layer_grid.style.display="block";C.style.color="gray";shader_grid.style.display="none";Q.style.color="gray";device_grid.style.display="none"}function ak(){ae.style.color="gray";server_grid.style.display="none";C.style.color="white";shader_grid.style.display="block";v.style.color="gray";layer_grid.style.display="none";Q.style.color="gray";device_grid.style.display="none"}function k(){ae.style.color="gray";server_grid.style.display="none";v.style.color="gray";layer_grid.style.display="none";C.style.color="gray";shader_grid.style.display="none";Q.style.color="white";device_grid.style.display="block"}af();N()};